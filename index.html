<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"l4qiang.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="记录点滴，注重积累。">
<meta property="og:type" content="website">
<meta property="og:title" content="CrazyAirhead">
<meta property="og:url" content="http://l4qiang.me/index.html">
<meta property="og:site_name" content="CrazyAirhead">
<meta property="og:description" content="记录点滴，注重积累。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="L4qiang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://l4qiang.me/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>CrazyAirhead</title>
  


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2613e7f510eebd12cf4d0d067e4ce195";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CrazyAirhead</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">疯狂的傻瓜，傻瓜也疯狂——傻方能执著，疯狂才专注!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/crazy-airhead" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/23/course100/030/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/23/course100/030/" class="post-title-link" itemprop="url">Solon Cloud —— 服务注册与发现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-23 14:29:56 / 修改时间：14:37:54" itemprop="dateCreated datePublished" datetime="2025-02-23T14:29:56+08:00">2025-02-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>服务注册与发现是一种动态管理服务实例的机制，其目的是让各个服务能够及时了解其他服务的状态与位置，以便能进行相互的通讯与协作。</p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>添加 nacos2 的依赖 <code>org.noear:nacos2-solon-cloud-plugin</code>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation platform(project(<span class="string">&quot;:demo-parent&quot;</span>))</span><br><span class="line"></span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-web&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-logging-logback&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-openapi2-knife4j&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:nacos2-solon-cloud-plugin&quot;</span>)</span><br><span class="line">    <span class="comment">// 使用 httputils</span></span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-net-httputils&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用 NamiClient</span></span><br><span class="line">    implementation(<span class="string">&quot;org.noear:nami-coder-snack3&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:nami-channel-http&quot;</span>)</span><br><span class="line"></span><br><span class="line">    annotationProcessor(<span class="string">&quot;org.mapstruct:mapstruct-processor:$&#123;mapstructVersion&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    testImplementation(<span class="string">&quot;org.noear:solon-test-junit5&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Nacos2 插件已经做了些默认值，所以我不需要过多的配置即可连接到 nacos 发现服务，如果使用了server 节点，意思是配置服务和发现服务使用同一个配置，或者单独使用<code>solon.cloud.nacos.discovery.server</code>配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">solon.app:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;demo-cloud-config&quot;</span></span><br><span class="line">  <span class="comment"># group: &quot;DEFAULT_GROUP&quot; # 默认值为 DEFAULT_GROUP</span></span><br><span class="line">  <span class="comment"># namespace: &quot;public&quot; # 默认值为 public</span></span><br><span class="line"></span><br><span class="line"><span class="attr">solon.cloud.nacos:</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">&quot;localhost:8848&quot;</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">load:</span> <span class="string">&quot;demo-cloud-config.yml&quot;</span></span><br><span class="line">  <span class="comment"># discovery:</span></span><br><span class="line">  <span class="comment">#   server: &quot;localhost:8848&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><h3 id="测试服务"><a href="#测试服务" class="headerlink" title="测试服务"></a>测试服务</h3><p>测试服务中我们提供一个hello接口，并增加表示是从 Service01 的标识。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> com.example.demo.solon.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Controller;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Param;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(&quot;Demo&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@ApiOperation(&quot;hello&quot;)</span></span><br><span class="line">  <span class="meta">@Mapping(&quot;/hello&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@Param(defaultValue = &quot;world&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s!, By Service01&quot;</span>, name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DemoController"><a href="#DemoController" class="headerlink" title="DemoController"></a>DemoController</h3><p>Solon 的 NamiClient 或者 HttpUtils 可以通过服务名来调用服务，其中NamiClient可以通过类似FeignClient的注解的方式进行使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.solon.client.DemoClient;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.noear.nami.annotation.NamiClient;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Controller;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Param;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.net.http.HttpUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Api(&quot;Demo&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@NamiClient</span> <span class="keyword">private</span> DemoClient demoClient;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;hello&quot;)</span></span><br><span class="line">  <span class="meta">@Mapping(&quot;/hello&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@Param(defaultValue = &quot;world&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> HttpUtils.http(<span class="string">&quot;demo-cloud-service01&quot;</span>, <span class="string">&quot;/hello&quot;</span>).data(<span class="string">&quot;name&quot;</span>, name).get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;hello2&quot;)</span></span><br><span class="line">  <span class="meta">@Mapping(&quot;/hello2&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">hello2</span><span class="params">(<span class="meta">@Param(defaultValue = &quot;world&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> demoClient.hello(name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DemoClient"><a href="#DemoClient" class="headerlink" title="DemoClient"></a>DemoClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.noear.nami.annotation.NamiClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NamiClient(name = &quot;demo-cloud-service01&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoClient</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">hello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>运行 demo-cloud-discovery 和 demo-cloud-service01，我们可以通过 nacos 看到服务到已经注册上来了。</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWRhODU4NzA4NWQ4YzlhM2EyMzliOTNlZWVhMzQ4MmRfU3FZVXhiVm84SHZsRjFuRjV6TldpQmtEaHBscDN3dWVfVG9rZW46SEJnSWJVRDNvb0sySFp4eWQyNmM0dzFybm1nXzE3NDAyOTIzMzE6MTc0MDI5NTkzMV9WNA" alt="img"></p>
<p>接下来通过 hello 和 hello2 接口测试 两种不同方式的调用。</p>
<p>通过 httputils 调用服务</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=MDJhMGM1OTA5MWYwZjkwZDljZjVmMGU3M2ZlYWE0N2VfNW5rOFJrM0c3dEZSQm5xOXBlUVRWRTkxZkp5bzF5NHFfVG9rZW46TmFOUmI0d2JEb2NRdUp4Q2w3T2NqckQxbjljXzE3NDAyOTIzMzE6MTc0MDI5NTkzMV9WNA" alt="img"></p>
<p>通过 NamiClient</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=OGYyODRmNzNkZmY0ZWZmMDQwNjBkNThlOTI0ODI4N2ZfS3NMakJmM291NEZLVXIzVnpXWnpvZ2Z1Nk5hM20yNGVfVG9rZW46T0JHbmJBV0Job1RIeGV4dzY5WmNzdFowblVoXzE3NDAyOTIzMzE6MTc0MDI5NTkzMV9WNA" alt="img"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过简单的配置，我们就可以把服务注册的 Nacos 中，并可以通过服务名的方式调用其他服务。当我们在普通的服务中增加服务配置和服务注册与发现功能配置后，就可以算作系统中的一个分布式微服务了，可以关注于业务的开发了。而 Solon Cloud 的接下来的更多的面向系统的可用性，可维护性等。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/22/course100/029/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/22/course100/029/" class="post-title-link" itemprop="url">Solon Cloud —— 服务配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-22 11:21:59 / 修改时间：11:24:47" itemprop="dateCreated datePublished" datetime="2025-02-22T11:21:59+08:00">2025-02-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>Nacos <code>/nɑ:kəʊs/</code> 是 Dynamic Naming and Configuration Service的首字母简称，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</p>
<p>接下来的服务配置和服务注册，我们使用的是 Nacos2。 需要自己部署好 Nacos2 ，具体内容可以参看 Nacos 的官网 <a target="_blank" rel="noopener" href="https://nacos.io/docs/latest/quickstart/quick-start%E3%80%82">https://nacos.io/docs/latest/quickstart/quick-start。</a></p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>添加 nacos2 的依赖 <code>org.noear:nacos2-solon-cloud-plugin</code>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation platform(project(<span class="string">&quot;:demo-parent&quot;</span>))</span><br><span class="line"></span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-web&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-logging-logback&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-openapi2-knife4j&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:nacos2-solon-cloud-plugin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    annotationProcessor(<span class="string">&quot;org.mapstruct:mapstruct-processor:$&#123;mapstructVersion&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    testImplementation(<span class="string">&quot;org.noear:solon-test-junit5&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Nacos2 插件已经做了些默认值，所以我不需要过多的配置即可连接到 nacos 配置中心。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">solon.app:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;demo-cloud-config&quot;</span></span><br><span class="line">  <span class="comment"># group: &quot;DEFAULT_GROUP&quot; # 默认值为 DEFAULT_GROUP</span></span><br><span class="line">  <span class="comment"># namespace: &quot;public&quot; # 默认值为 public</span></span><br><span class="line"></span><br><span class="line"><span class="attr">solon.cloud.nacos:</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">&quot;localhost:8848&quot;</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">load:</span> <span class="string">&quot;demo-cloud-config.yml&quot;</span></span><br></pre></td></tr></table></figure>

<p>load 使用<code>group:dataId</code>的格式加载配置配置文件，当加载的配置文件与 <code>solon.app.group</code> 配置的 group 一致时可以不用配置 group 的部分，也就是只需要 dataId 的部分即可。如果需要加载多个配置文件，使用逗号(,)分隔，加载多个配置文件通用配置特别有用，避免了在多个地方管理配置文件。</p>
<p>通过 load 加载的配置文件会进入 <code>Solon.cfg()</code> 成为应用配置，这样就可以通过 <code>@Injtect</code> 的方式进行注入。</p>
<p>以下是一份更详细的配置，内容来自官网 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/400">https://solon.noear.org/article/400</a> ，可以根据实际的需要进行配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">solon.app:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;demoapp&quot;</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">&quot;demo&quot;</span></span><br><span class="line">  <span class="attr">meta:</span>                   <span class="comment">#添加应用元信息（可选）</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">&quot;v1.0.2&quot;</span> </span><br><span class="line">    <span class="attr">author:</span> <span class="string">&quot;noear&quot;</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">&quot;aaa,bbb,ccc&quot;</span>     <span class="comment">#添加应用标签（可选）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">solon.cloud.nacos:</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">&quot;localhost:8848,localhost:8847&quot;</span>  <span class="comment">#nacos 服务地址</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">&quot;3887EBC8-CD24-4BF7-BACF-58643397C138&quot;</span> <span class="comment">#nacos 命名空间</span></span><br><span class="line">  <span class="attr">contextPath:</span> <span class="string">&quot;nacosx&quot;</span>                    <span class="comment">#nacos 服务的上下文路径（可选）</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;aaa&quot;</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;bbb&quot;</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">load:</span> <span class="string">&quot;demoapp.yml,group:test.yml&quot;</span>                <span class="comment">#加载配置到应用属性（多个以&quot;,&quot;隔开）</span></span><br><span class="line">  <span class="attr">discovery:</span></span><br><span class="line">    <span class="attr">clusterName:</span> <span class="string">&quot;DEFAULT&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="获取配置"><a href="#获取配置" class="headerlink" title="获取配置"></a>获取配置</h3><p>使用 nacos 的配置是期望获取统一的，动态的配置，所以这里开启自动刷新 <code>autoRefreshed = true</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Inject;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Inject(value = &quot;$&#123;app&#125;&quot;, autoRefreshed = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String appId;</span><br><span class="line">  <span class="keyword">private</span> String appKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是通过 <code>@Injtect</code> 的方式进行注入使用对应的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(&quot;配置管理&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> AppConfig appConfig;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取配置文件"><a href="#获取配置文件" class="headerlink" title="获取配置文件"></a>获取配置文件</h3><p>获取配置文件根据 dataId 获取配置，通过 <code>@CloudConfig</code> 进行注入。CloudConfig 暂时不支持注解的类上，也就是不能使用如下的方法配合 @Inject 进行注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.cloud.annotation.CloudConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过类获取dataId的配置，暂不支持的。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@CloudConfig(value = &quot;demo-db&quot;, autoRefreshed = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoDbConfig</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String url;</span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Inject 暂时暂时不到值的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api(&quot;配置管理&quot;)</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** 获取dataId的配置，获取不到值 */</span></span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> DemoDbConfig demoDbConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确的方式是，把 CloudConfig 注解在属性上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** 获取dataId的配置，获取不到值 */</span></span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> DemoDbConfig demoDbConfig;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> AppConfig appConfig;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CloudConfig(value = &quot;demo-db&quot;, autoRefreshed = true)</span></span><br><span class="line">  <span class="keyword">private</span> Properties properties;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CloudConfig(value = &quot;demo-db&quot;, autoRefreshed = true)</span></span><br><span class="line">  <span class="keyword">private</span> DemoDbConfig demoDbConfig2;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>通过 Swagger 测试可以正常获取到配置，并且修改 Nacos 的配置后，再次调用接口配置会更新（这里没有截图）。</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=NzVhYWRhZDAwYjQ1ODZiYWJlMGU2MGE2Y2RiOGI1OWJfVjBzOWx2SDdVaGI5eHptcUxiTGRXRkVsTGRyOU1FSVpfVG9rZW46S25tcGJQQ0lpb2VWaDd4dk5tUmNkVE9Rbm1iXzE3NDAxOTQ2MjU6MTc0MDE5ODIyNV9WNA" alt="img"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在 Solon Cloud 中通过简单的配置就可以使用 Nacos 配置中心了。在实际的使用过程中注意区分@Inject 和@CloudConfig 的不同，一个是针对key来的，一个是针对dataId来的。为了减少自己在开发过程中的混乱（有时过多的选择不是一件好事情），可以约定使用 load 的方式加载多个配置文件，使用 @Inject 的方式进行注入后使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/21/course100/028/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/21/course100/028/" class="post-title-link" itemprop="url">Solon Cloud —— 介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-02-21 21:50:36" itemprop="dateCreated datePublished" datetime="2025-02-21T21:50:36+08:00">2025-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-22 11:23:02" itemprop="dateModified" datetime="2025-02-22T11:23:02+08:00">2025-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>前面的章节，我们讲解了 Solon 的开发应用，接下来准备讲解 Solon Cloud 的的开发。Solon Cloud 是为微服务和云原生准备的分布式开发套件。</p>
<h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><p>就像 MVC 一样，对于微服务的理解也是有不同的。微服务是一组协调工作的小而自治的服务。微服务是一组分布式的架构框架。</p>
<p>微服务有支持异构，弹性，易扩展，容易替换等优点，但也增加了开发、测试、部署、运维的复杂性。</p>
<h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><p>为了解决微服务（或者系统）的开发、部署、运维的复杂性，CNCF （Cloud Native Computing Foudation）提出了云原生的概念，就是利用各组织在共有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。主要涉及DevOps，CI/CD，Micro Service，Contianer等四个大的方面。</p>
<h2 id="Solon-Cloud"><a href="#Solon-Cloud" class="headerlink" title="Solon Cloud"></a>Solon Cloud</h2><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=MjUxZDZmMjRiMmJmOGYzNzAyMTI0ZjU2M2E5OTZmZmRfcmNhUEJsRng3SnBpZ0N0TUw4TUpGRjI0TWljUU5jYThfVG9rZW46VE9zMmJtcktKbzVYQXJ4ZEJ3TWM0NHVLbjFiXzE3NDAxNDYyODI6MTc0MDE0OTg4Ml9WNA" alt="img"></p>
<p>从上图，我们可以看到 Solon Cloud 的主要组成部分：</p>
<ul>
<li>Solon Cloud Gateway 分布式网关相关插件</li>
<li>Solon Cloud Config 分布式配置相关插件</li>
<li>Solon Cloud Discovery 分布式注册与发现相关插件</li>
<li>Solon Cloud Event 分布式时间总线相关插件</li>
<li>Solon Cloud Job 分布式任务调度插件</li>
<li>Solon Cloud File 分布式文件插件</li>
<li>Solon Cloud Log 分布式日志插件</li>
<li>Solon Cloud Trace 分布式跟踪插件</li>
<li>Solon Cloud Metrics 分布式监控插件</li>
<li>Solon Cloud Breaker 分布式熔断插件</li>
<li>Solon Cloud Id 分布式 ID 插件</li>
<li>Solon Cloud I18n 分布式国际化配置插件</li>
<li>Solon Cloud List 分布式名单，白名单、黑名单等</li>
<li>Solon Cloud Lock 分布式锁插件</li>
</ul>
<p>我们可以看到Solon Cloud 其实是定义了一组接口规范，在这个接口规范的基础上实现不同分布式组件的插件。</p>
<p>在 Solon 的官网中也对分布式设计做了引导，我这里列出重点的部分，详细内容可查看官网 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/638%E3%80%82">https://solon.noear.org/article/638。</a></p>
<ol>
<li>构建可水平扩展的计算能力<ol>
<li>服务无状态</li>
<li>服务透明化</li>
<li>容器弹性伸缩</li>
</ol>
</li>
<li>构建可水平扩展的业务能力<ol>
<li>基于业务领域拆分微服务</li>
<li>拆分业务的主线与辅线</li>
<li>基于实现总线交互</li>
</ol>
</li>
</ol>
<h2 id="书籍推荐"><a href="#书籍推荐" class="headerlink" title="书籍推荐"></a>书籍推荐</h2><h3 id="《微服务架构设计模式》"><a href="#《微服务架构设计模式》" class="headerlink" title="《微服务架构设计模式》"></a>《微服务架构设计模式》</h3><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=NWI2NWJkYmVmMTM5MTk4ODIxZWU4NDJjNjllMDM1OTFfRlF5WnB4UHFTUXFhN0hGMzcyeUl3T0wycThIQWUxRnBfVG9rZW46WjZYOGJldHY5bzRLOUt4N2xoSmNhVk01bkhkXzE3NDAxNDYyODI6MTc0MDE0OTg4Ml9WNA" alt="img"></p>
<h3 id="《微服务设计》"><a href="#《微服务设计》" class="headerlink" title="《微服务设计》"></a>《微服务设计》</h3><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTlmNjA0NzViNzc3N2Q3ODY3ODIzYmZkMTU4MDgwNmZfdUJvWU5YRzNqTVlPYVNLMkNRdXNMeU1mNVRKSVFmbjZfVG9rZW46Q0JlUmJaazdFbzdpNWJ4OGxsVmN0SjhrbnhWXzE3NDAxNDYyODI6MTc0MDE0OTg4Ml9WNA" alt="img"></p>
<h3 id="The-Twelve-factor-App"><a href="#The-Twelve-factor-App" class="headerlink" title="The Twelve-factor App"></a>The Twelve-factor App</h3><p><a target="_blank" rel="noopener" href="https://12factor.net/">https://12factor.net/</a></p>
<h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><p>在本教程的介绍中说到，本教程更面向使用，因此会限制技术栈，对于Solon Cloud 的使用也是一样的，基础的服务：</p>
<ul>
<li>Nacos2 配置管理、服务发现。</li>
<li>Redis，分布式 ID，分布式锁等。</li>
<li>Skywalking，链路跟踪。</li>
<li>Kafka 消息服务。</li>
<li>Sentinel 熔断</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/20/course100/027/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/20/course100/027/" class="post-title-link" itemprop="url">Solon —— 插件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-20 20:13:23 / 修改时间：20:18:52" itemprop="dateCreated datePublished" datetime="2025-02-20T20:13:23+08:00">2025-02-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>Solon 是典型的微内核架构，通过框架核心提供了插件的核心接口和生命周期的管理。在之前的应用的生命周期中讲到过插件的三个生命时机点。通过这三个时机点，插件开发人员可以管理插件的资源初始化与资源的销毁。</p>
<p>Solon 的插件支持三种形式的运行方式：</p>
<ol>
<li>Spi 方式。是基于插件和配置声明的扩展方式，类似Spring Factories，主应用需要增加对插件的依赖。</li>
<li>E-Spi 方式，也叫体外扩展。是基于插件和动态配置的扩展方式，类似Springboot-plugin-fraework，主程序不需要增加对插件的依赖。</li>
<li>H-Spi 方式，也叫热插拔扩展。是基于插件和手动管理的扩展方式，类似Springboot-plugin-fraework，主程序不需要增加对插件的依赖。</li>
</ol>
<p>这三种扩展方式对于开发插件本身没有什么区别，主要的区别是主应用的依赖和配置等，和实现的效果的不同，具体的特性对比可以参看官网 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/441">https://solon.noear.org/article/441</a> 相关的文章。</p>
<p>插件涉及的示例代码包含多个模块，具体参看 <a target="_blank" rel="noopener" href="https://gitee.com/CrazyAirhead/porpoise-demo%EF%BC%9A">https://gitee.com/CrazyAirhead/porpoise-demo：</a></p>
<ul>
<li>demo-solon03-plugin Solon 插件</li>
<li>demo-solon03-main01 Solon 主应用 Spi</li>
<li>demo-solon03-main02 Solon 主应用 E-Spi</li>
<li>demo-solon03-main03 Solon 主应用 H-Spi</li>
</ul>
<h2 id="插件-demo-solon03-plugin"><a href="#插件-demo-solon03-plugin" class="headerlink" title="插件 demo-solon03-plugin"></a>插件 demo-solon03-plugin</h2><p>实现  hello 的基础功能。</p>
<h3 id="实现-Plugin-接口"><a href="#实现-Plugin-接口" class="headerlink" title="实现 Plugin 接口"></a>实现 Plugin 接口</h3><p>这里为了简单，直接扫描了插件包的 Bean 对象，在实际的开发过程中可根据实际的实现使用Conetext的其他方法构建 Bean，或者订阅 Bean，或者加载配置文件等，来完成实际的插件初始化操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.AppContext;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.Plugin;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoSolonPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(AppContext context)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// 简单起见，直接扫描插件所在包，可以根据实际的需要进行定制化的加载</span></span><br><span class="line">    context.beanScan(DemoSolonPlugin.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prestop</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Plugin.<span class="keyword">super</span>.prestop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// 移除http处理。在热插拔的插件中特别</span></span><br><span class="line">    Solon.app().router().remove(<span class="string">&quot;/hello&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现-Controller"><a href="#实现-Controller" class="headerlink" title="实现 Controller"></a>实现 Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.plugin.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Controller;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Param;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Mapping(&quot;/hello&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(<span class="meta">@Param(defaultValue = &quot;world&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">&quot;Hello %s!&quot;</span>, name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置插件文件"><a href="#配置插件文件" class="headerlink" title="配置插件文件"></a>配置插件文件</h3><p>在 <code>resources/META-INF/solon/</code> 目录下创建插件配置文件，文件名要在应用范围内全局唯一，为了避免冲突可以使用插件的包名做了文件名。</p>
<p>这里使用是<code>META-INF/solon/com-example-demo-solon-plugin.properties</code>，文件内容如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 插件实现类</span></span><br><span class="line"><span class="meta">solon.plugin</span>=<span class="string">com.jishunetwork.ficus.framework.server.XPluginImp</span></span><br><span class="line"><span class="comment"># 插件加载优先级，越大越优先，默认为0</span></span><br><span class="line"><span class="meta">solon.plugin.priority</span>=<span class="string">1</span></span><br></pre></td></tr></table></figure>

<p>这里常见的问题：文件目录错误，注解检查是二级目录，目录名是<code>/META-INF/solon/</code>；插件的实现类写错，可以通过点击的方式看下能否正常跳转到对应的类上来验证配置是否正确。</p>
<h2 id="Spi-demo-solon03-main01"><a href="#Spi-demo-solon03-main01" class="headerlink" title="Spi demo-solon03-main01"></a>Spi demo-solon03-main01</h2><p>只要添加对应的依赖即可不需要其他额外的配置。</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation platform(project(<span class="string">&quot;:demo-parent&quot;</span>))</span><br><span class="line"></span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-web&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-logging-logback&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-openapi2-knife4j&quot;</span>)</span><br><span class="line">    implementation(project(<span class="string">&quot;:demo-solon03-plugin&quot;</span>))</span><br><span class="line"></span><br><span class="line">    annotationProcessor(<span class="string">&quot;org.mapstruct:mapstruct-processor:$&#123;mapstructVersion&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    testImplementation(<span class="string">&quot;org.noear:solon-test-junit5&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>调用插件实现的接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/hello%EF%BC%8C%E8%BF%94%E5%9B%9Ehello">http://127.0.0.1:8080/hello，返回hello</a> world!</p>
<h2 id="E-Spi-demo-solon03-main02"><a href="#E-Spi-demo-solon03-main02" class="headerlink" title="E-Spi demo-solon03-main02"></a>E-Spi demo-solon03-main02</h2><p>只要添加修改配置，把插件放入指定文件夹路径即可。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>此时把插件目录放在jar相对路径的plugin下。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">solon.extend:</span> <span class="string">&quot;!plugin&quot;</span></span><br></pre></td></tr></table></figure>

<p>注意：在idea中可能一下不能区分plugin再那个目录，可以先运行一次让 Solon 把目录创建出来，然后再把插件放到 plugin 目录下，此时我们可以看到是在<code> build/classes/java/main</code> 目录下。把demo-solon03-plugin的插件放入plugin 目录后重新启动程序（注意此时不能再clean了，否则 刚放入的文件又被清理了）。</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=NWY1NjY2YmI5MDRjNDY1ZWM0NWFmMjFhZjg1MWUxNTRfUTI3RmZpSklvM2pIS2pUaU5XNm0xR3FBVDl4MDF0eFRfVG9rZW46QnN5amIwTnV2bzRjMWF4MXR1SmMzbFhNbjFiXzE3NDAwNTM2NTQ6MTc0MDA1NzI1NF9WNA" alt="img"></p>
<h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>调用插件实现的接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/hello%EF%BC%8C%E8%BF%94%E5%9B%9Ehello">http://127.0.0.1:8080/hello，返回hello</a> world!</p>
<h2 id="H-Spi-demo-solon03-main03"><a href="#H-Spi-demo-solon03-main03" class="headerlink" title="H-Spi demo-solon03-main03"></a>H-Spi demo-solon03-main03</h2><p>热插拔的就是允许应用可以更灵活的管理插件的生命周期，因为热插拔是完全隔离的，因此需要自己更严格的管理资源的，更独立，避免与别的组件交互，避免不可拔的情况。</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation platform(project(<span class="string">&quot;:demo-parent&quot;</span>))</span><br><span class="line"></span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-web&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-logging-logback&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-openapi2-knife4j&quot;</span>)</span><br><span class="line">    implementation(<span class="string">&quot;org.noear:solon-hotplug&quot;</span>)</span><br><span class="line"></span><br><span class="line">    annotationProcessor(<span class="string">&quot;org.mapstruct:mapstruct-processor:$&#123;mapstructVersion&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    testImplementation(<span class="string">&quot;org.noear:solon-test-junit5&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>这里使用 Solon 默认提供的配置来管理，在加载的插件的过程中，只要能找到插件就可以了，不一定需要使用这个配置，注意路径是绝对路径。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">solon.hotplug:</span></span><br><span class="line">  <span class="attr">demo:</span> <span class="string">/plugin/demo-solon03-plugin-1.0.0.jar</span></span><br></pre></td></tr></table></figure>

<h3 id="实现管理"><a href="#实现管理" class="headerlink" title="实现管理"></a>实现管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.solon.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Controller;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.hotplug.PluginManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Mapping(&quot;start&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PluginManager.start(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;stop&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PluginManager.stop(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证-2"><a href="#验证-2" class="headerlink" title="验证"></a>验证</h3><ol>
<li>调用插件实现的接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/hello%EF%BC%8C%E6%AD%A4%E6%97%B6%E4%B8%8D%E5%8F%AF%E8%AE%BF%E9%97%AE">http://127.0.0.1:8080/hello，此时不可访问</a></li>
<li>调用启动插件接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/start%EF%BC%8C%E8%BF%94%E5%9B%9Eok">http://127.0.0.1:8080/start，返回ok</a></li>
<li>调用插件实现的接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/hello%EF%BC%8C%E6%AD%A4%E6%97%B6%E8%BF%94%E5%9B%9E">http://127.0.0.1:8080/hello，此时返回</a> hello world</li>
<li>调用停止插件接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/stop%EF%BC%8C%E8%BF%94%E5%9B%9Eok">http://127.0.0.1:8080/stop，返回ok</a></li>
<li>调用插件实现的接口，<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/hello%EF%BC%8C%E6%AD%A4%E6%97%B6%E4%B8%8D%E5%8F%AF%E8%AE%BF%E9%97%AE">http://127.0.0.1:8080/hello，此时不可访问</a></li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过 Solon 提供的插件机制能简单、弹性、自由的实现功能扩展，既可以做框架型的插件开发，也可以做业务性的插件开发。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/19/course100/026/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/19/course100/026/" class="post-title-link" itemprop="url">Solon —— 容器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-19 22:46:49 / 修改时间：22:48:20" itemprop="dateCreated datePublished" datetime="2025-02-19T22:46:49+08:00">2025-02-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>Solon 的核心概念有 IoC、AOP 和本地事件总线。有人常常有误解以为 IoC 和 AOP 是 Spring 提出的，其实这两种思想在Spring 之前就已经有了，但 Spring 把这两个思想在技术上落地和推广做得很好，让 Ioc 和 AOP 广为人知。</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h3><p>Ioc 的全称是 Inversion of Control，是控制反转或者反转控制的意思。它是一种思想，主要解决的是对象创建和管理的问题，用于解耦依赖。Ioc有时也被称为 DI （Dependency Injection），依赖注入。在使用 IoC 的过程中，我们是通过容器来创建和管理对象的，我们也是从容器中获取对象，所以，有时我们会听到 IoC 就是容器的说法，可能只是简化的一种说法。</p>
<h3 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h3><p>AOP， 全称 Aspect Oriented Programming，是面向切面编程。AOP 的目的是将横切关注点（如日志记录、事务管理、权限控制、接口限流、接口幂等等）从核心业务逻辑中分离出来，通过动态代理、字节码操作等技术，实现代码的复用和解耦，提高代码的可维护性和可扩展性。其中涉及的核心有代理，切点，切面。</p>
<h3 id="本地事件总线"><a href="#本地事件总线" class="headerlink" title="本地事件总线"></a>本地事件总线</h3><p>本地事件总线是 Solon 在应用生命周期提供的扩展机制，应用可以根据需要的事件时机点，订阅响应的事件。本地事件总线支持自定义的事件。</p>
<p>注意：</p>
<ol>
<li>本地事件总线是基于应用生命周期的（应用的启停，插件的启停，bean 创建等），而不是基于业务，如果是涉及业务，可以使用使用作者的另一个作品 DamiBus。</li>
<li>要在事件发生前订阅事件，否则会错过时机，无法接收到事件消息。</li>
</ol>
<h2 id="应用生命周期"><a href="#应用生命周期" class="headerlink" title="应用生命周期"></a>应用生命周期</h2><p>应用生命周期，是应用程序从 启动到最后停止的整个过程。应用生命周期当中存在一些关键点，可称为时机点。</p>
<p>SolonApp 的应用生命周期如下图所示，其中时机点包括有：一个初始化函数时机点 + 六个应用事件时机点 + 三个插件生命时机点 + 两个容器生命时机点。</p>
<p>作者的这张图画的很细致，一步步的把这个图走完，能加深对 Solon 的理解。</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=YzEwOWMxN2RlZjZhZDdhNjEyYTU4YjBmNGM0MjBlNzZfS2xQRTJaWEZZbGlNaVU5Q3VNM0lwakpncUs0R0dUMDZfVG9rZW46SjBNRmJrc3I4b05KbGp4ZGUzZ2NsS01qblRjXzE3Mzk5NzY0NDk6MTczOTk4MDA0OV9WNA" alt="img"></p>
<h3 id="一个初始化函数时机点"><a href="#一个初始化函数时机点" class="headerlink" title="一个初始化函数时机点"></a>一个初始化函数时机点</h3><p>应用开发时可扩展的时机。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SolonMain</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Solon.start(App.class, args, (app) -&gt; &#123;</span><br><span class="line">            <span class="comment">//应用初始化时机点</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="六个应用事件时机点"><a href="#六个应用事件时机点" class="headerlink" title="六个应用事件时机点"></a>六个应用事件时机点</h3><p>应用开发时可扩展的时机。</p>
<table>
<thead>
<tr>
<th>事件</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>6.AppInitEndEvent</td>
<td>应用初始化完成事件</td>
<td>只支持手动订阅</td>
</tr>
<tr>
<td>8.AppPluginLoadEndEvent</td>
<td>应用插件加载完成事件</td>
<td>只支持手动订阅</td>
</tr>
<tr>
<td>b.AppBeanLoadEndEvent</td>
<td>应用Bean加载完成事件（即扫描完成）</td>
<td></td>
</tr>
<tr>
<td>e.AppLoadEndEvent</td>
<td>应用加载完成事件（即启动完成）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>::运行</td>
<td></td>
</tr>
<tr>
<td>g.AppPrestopEndEvent</td>
<td>应用预停止事件</td>
<td></td>
</tr>
<tr>
<td>j.AppStopEndEvent</td>
<td>应用停止事件</td>
<td></td>
</tr>
</tbody></table>
<h3 id="三个插件生命时机点"><a href="#三个插件生命时机点" class="headerlink" title="三个插件生命时机点"></a>三个插件生命时机点</h3><p>插件开发时可扩展的时机。</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>执行时机</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>7.start</td>
<td>在应用初始化完成后执行</td>
<td>启动</td>
</tr>
<tr>
<td>f.prestop</td>
<td>在 ::stop 前执行</td>
<td>预停止</td>
</tr>
<tr>
<td>h.stop</td>
<td>在 Solon::stop 时执行</td>
<td>停止（启用安全停止时，prestop 后等几秒再执行 stop）</td>
</tr>
</tbody></table>
<h3 id="两个容器生命时机点"><a href="#两个容器生命时机点" class="headerlink" title="两个容器生命时机点"></a>两个容器生命时机点</h3><p>Solon 内部的时机点，应用开发不可扩展。</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>执行时机</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>d.start</td>
<td>在扫描完成之后执行</td>
<td>启动</td>
</tr>
<tr>
<td>i.stop</td>
<td>在 Solon::stop 时执行，在插件（h.stop）后执行</td>
<td>停止</td>
</tr>
</tbody></table>
<h2 id="Bean-生命周期"><a href="#Bean-生命周期" class="headerlink" title="Bean 生命周期"></a>Bean 生命周期</h2><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDk4YjliYzk4OGEzMzkxZjM3MjlhMDdhMjIwM2Y3YjJfTzZzdEFmc0wyRVc3d1JRaGNqNWVydFlVNnA2MkdDMjdfVG9rZW46VTlRV2JpTkREb011Rlp4UjZKR2NhdHJlbmloXzE3Mzk5NzY0NDk6MTczOTk4MDA0OV9WNA" alt="img"></p>
<p>被容器托管的 Bean，它的生命周期只限定在容器内部。</p>
<h4 id="new"><a href="#new" class="headerlink" title="::new()"></a>::new()</h4><p>就是调用构造函数，是在 Bean 被扫描时，且符合条件才会执行。</p>
<p>注意，这个时候，Bean 还注册到容器中，还不能使用注入的字段（还未注入）。如果要初始化，推荐使用<code>@Init</code> 函数。</p>
<h4 id="Inject"><a href="#Inject" class="headerlink" title="@Inject"></a>@Inject</h4><p>开始执行注入。之后就会注册到容器，并通知订阅者。</p>
<h4 id="start-或-Init"><a href="#start-或-Init" class="headerlink" title="start() 或 @Init"></a>start() 或 @Init</h4><p>执行初始化动作，在 AppContext::start() 开始处被执行。如果使用 start() 需要实现 LifecycleBean 接口。此时 Bean 扫描已完成，理论上所有的 Bean 都已进入容器（某些特殊的 Bean 是在 AppContext.start() 时才生产的），并且所有 Bean 的字段都已完成注入。</p>
<h4 id="postStart"><a href="#postStart" class="headerlink" title="postStart()"></a>postStart()</h4><p>开始之后，AppContext::start() 结束处被执行，一般用于启动一些任务。如果使用 postStart() 需要实现 LifecycleBean 接口。</p>
<h4 id="preStop"><a href="#preStop" class="headerlink" title="preStop()"></a>preStop()</h4><p>预停止，AppContext::preStop() 时被执行。一般用来做分布式服务注销之类。如果使用 preStop() 需要实现 LifecycleBean 接口。</p>
<h4 id="stop-或-Destroy"><a href="#stop-或-Destroy" class="headerlink" title="stop() 或 @Destroy"></a>stop() 或 @Destroy</h4><p>停止，AppContext::stop() 时被执行。一般用来做安全停止。如果使用 stop() 需要实现 LifecycleBean 接口。</p>
<h2 id="容器应用"><a href="#容器应用" class="headerlink" title="容器应用"></a>容器应用</h2><p>在 Solon 中，我们可以自由的选择用注解的方式，还是手动的方式来实现想要的功能。但在这里我们主要讲解注解的使用方式。</p>
<h3 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h3><p>扫描一般是深度遍历指定“包名”下的 <code>.class</code> 文件获取类名，再通过类名从类加载器里获取元信息。</p>
<p>默认情况下，主类所在包名新的类都会扫描。如果需要修改导入的范围可以使用 @Import 注解，增加扫描的包名，或者导入需要的类名。</p>
<h3 id="构建-注入"><a href="#构建-注入" class="headerlink" title="构建 / 注入"></a>构建 / 注入</h3><p>在 Solon 中，我们通过Singleton，Configuration，Bean，Component，Controller，Remoting等方式产生Bean，在Bean 对象中，我们可以 @Inject 注解注入字段。在构建和注入中需要注意的可能是条件构建和依赖注入的部分了。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Inject *</td>
<td>注入托管对象（by type）</td>
</tr>
<tr>
<td>@Inject(“name”)</td>
<td>注入托管对象（by name）</td>
</tr>
<tr>
<td>@Inject(“${name}”)</td>
<td>注入配置（可由基础类型或结构体接收）</td>
</tr>
<tr>
<td>@Singleton</td>
<td>单例申明（Solon 默认是单例）</td>
</tr>
<tr>
<td>@Singleton(false)</td>
<td>非单例</td>
</tr>
<tr>
<td>@Configuration</td>
<td>托管配置组件类（与 @Inject, @Bean 共同完成初始化配置、构建托管对象等）</td>
</tr>
<tr>
<td>@Bean</td>
<td>配置托管对象（作用在 @Configuration 类的函数上，才有效）</td>
</tr>
<tr>
<td>@Component</td>
<td>托管组件（支持自动代理，v2.5.2 开始支持自动代理）</td>
</tr>
<tr>
<td>@Controller</td>
<td>控制器组件类（支持函数拦截）</td>
</tr>
<tr>
<td>@Remoting</td>
<td>远程控制器类（有类代理；即RPC服务端）</td>
</tr>
</tbody></table>
<h4 id="条件构建"><a href="#条件构建" class="headerlink" title="条件构建"></a>条件构建</h4><p>条件构建的意思是满足了指定条件才会构建。通过使用 @Condition 来实现，它包含如下的属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>onClass</td>
<td>有类（只能一个；其实没必要多个）</td>
</tr>
<tr>
<td>onClassName</td>
<td>有类名</td>
</tr>
<tr>
<td>onProperty</td>
<td>有属性</td>
</tr>
<tr>
<td>onMissingBean</td>
<td>没有 Bean</td>
</tr>
<tr>
<td>onMissingBeanName</td>
<td>没有 Bean Name</td>
</tr>
<tr>
<td>onBean</td>
<td>有 Bean</td>
</tr>
<tr>
<td>onBeanName</td>
<td>有 Bean Name</td>
</tr>
</tbody></table>
<p>更多细节，查看官网 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/434">https://solon.noear.org/article/434</a> 。</p>
<h4 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h4><p>依赖注入的意思是，在构建时需要使用到其他 Bean 对象。依赖注入通常使用@Configuration，配合@Bean 来实现，其中 @Bean 的函数通过参数注入的方式来获取需要的 Bean 对象。另外就是使用手动模式通过异步订阅的方式获取依赖的 Bean 对象。</p>
<p>以下注入的例子来自官网，更多细节，查看官网 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/587">https://solon.noear.org/article/587</a> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean(name=&quot;db1&quot;, typed=true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">db1</span><span class="params">(<span class="meta">@Inject(&quot;$&#123;demo.db1&#125;&quot;)</span> DataSource ds)</span></span>&#123; </span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">db1Test</span><span class="params">(<span class="meta">@Db(&quot;db1&quot;)</span> UserMapper mapper)</span> </span>&#123; <span class="comment">//这个注入，依赖“db1”的数据源</span></span><br><span class="line">        <span class="keyword">return</span> mapper.initUsers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/18/course100/025/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/18/course100/025/" class="post-title-link" itemprop="url">Solon —— 配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-18 19:54:02 / 修改时间：19:59:06" itemprop="dateCreated datePublished" datetime="2025-02-18T19:54:02+08:00">2025-02-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>Spring Boot 流行起来的一个原因是简化了配置，其中约定优于配置减少了开发者的配置负担，无需配置或者少量的配置就可以启动项目；自动化配置根据项目依赖自动配置应用程序，简化了开发流程。Solon 作为后起之秀也是采用了约定优于配置和自动配置的方式来简化配置。</p>
<h2 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h2><h3 id="配置分类"><a href="#配置分类" class="headerlink" title="配置分类"></a>配置分类</h3><h4 id="启动参数"><a href="#启动参数" class="headerlink" title="启动参数"></a>启动参数</h4><p>启动参数，在应用启动后会被静态化，也就是不能再修改。在Java 启动时指定，通过<code>--key=value</code>的形式指定。</p>
<h4 id="系统属性"><a href="#系统属性" class="headerlink" title="系统属性"></a>系统属性</h4><p>系统属性，在应用启动后会被静态化，也就是不能再修改。在Java 启动时指定，通过<code>-Dkey=value</code>的形式指定。</p>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p>操作系统的环境变量。”solon” 开头的环境变量，会被框架同步到系统属性（System::getProperties）与应用属性（Solon::cfg）。</p>
<h4 id="应用配置"><a href="#应用配置" class="headerlink" title="应用配置"></a>应用配置</h4><p>应用通过配置文件加载进来的配置。</p>
<h3 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h3><p>应用配置文件为 <code>resources/app.yml</code> 或者 <code>app.properties</code>，文件名不能修改也不能配置。</p>
<h3 id="配置加载规则"><a href="#配置加载规则" class="headerlink" title="配置加载规则"></a>配置加载规则</h3><p>应用配置的加载主要分了六个层级，其加载规则为：</p>
<ul>
<li>越静态的越前面</li>
<li>越动态的越后面</li>
</ul>
<p>因为配置是以“键”为单位，且后面加载的会盖掉前面加载的，所以最终效果就是配置以最后加载为准。</p>
<p>加载顺序为：</p>
<ol>
<li>主配置文件，先是主配置文件（app.yml），之后是带环境的主配置（app-{env}.yml）,这里不特别区分（yml或者properties）。</li>
<li>内部配置文件，通过 <code>solon.config.load</code>加载的 <code>classpath</code> 目录下的配置文件。</li>
<li>外部配置文件，通过 <code>solon.config.add</code> 加载的配置文件。</li>
<li>动态配置，启动应用时的配置，先是启动参数（–key=value），之后是系统属性（-Dkey=value），最后是环境变量（系统环境设置，或者docker -e 等方式指定）</li>
<li>启动时加载，通过 <code>app.cfg().loadAdd</code> 或者 <code>app.cfg().loadEnv</code>加载。</li>
<li>云端配置，通过分布式配置获取，如nacos。</li>
</ol>
<h3 id="配置引用规则"><a href="#配置引用规则" class="headerlink" title="配置引用规则"></a>配置引用规则</h3><p>配置文件（或配置块）解析时，Solon.cfg() 已经存在的变量（或者配置块内的变量），可以被引用。属性之间的引用，使用 <code>$&#123;...&#125;</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">test.demo1:</span> <span class="string">&quot;$&#123;db1.url&#125;&quot;</span>                          <span class="comment">#引用应用属性</span></span><br><span class="line"><span class="attr">test.demo2:</span> <span class="string">&quot;jdbc:mysql:$&#123;db1.server&#125;&quot;</span>            <span class="comment">#引用应用属性并组合</span></span><br><span class="line"><span class="attr">test.demo3:</span> <span class="string">&quot;jdbc:mysql:$&#123;db1.server&#125;/$&#123;db1.db&#125;&quot;</span>  <span class="comment">#引用多个应用属性并组合</span></span><br><span class="line"><span class="attr">test.demo4:</span> <span class="string">&quot;$&#123;JAVA_HOME&#125;&quot;</span>                        <span class="comment">#引用环境变量test.demo5: &quot;$&#123;.demo4&#125;&quot;                           #引用本级其它变量（v2.9.0 后支持）</span></span><br></pre></td></tr></table></figure>

<h3 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h3><p>配置可能变更，所以直接看官网 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/174">https://solon.noear.org/article/174</a> 。</p>
<h2 id="注入配置"><a href="#注入配置" class="headerlink" title="注入配置"></a>注入配置</h2><p>配置注入使用 <code>$&#123;...&#125;</code>的表达式，支持如下具体的配置：</p>
<ul>
<li><code>$&#123;xxx&#125;</code> 注入字段。</li>
<li><code>$&#123;xxx:def&#125;</code> 注入字段，如果没有则提供 def 默认值，此时只支持单值接收，不支持集合或实体。</li>
<li><code>$&#123;classpath:xxx.yml&#125;</code> 注入资源目录下的配置文件 xxx.xml</li>
</ul>
<h3 id="注入字段"><a href="#注入字段" class="headerlink" title="注入字段"></a>注入字段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoService</span></span>&#123;</span><br><span class="line">    <span class="comment">//注入值（带默认值：demoApi），并开启自动更新（注意：如果不是单例，请不要开启自动刷新）</span></span><br><span class="line">    <span class="meta">@Inject(value=&quot;$&#123;track.name:demoApi&#125;&quot;, autoRefreshed=true)</span></span><br><span class="line">    <span class="keyword">static</span> String trackName; <span class="comment">//v3.0 后支持静态字段注入//注入值（没有时，不覆盖字段初始值）</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Inject(&quot;$&#123;track.url&#125;&quot;)</span></span><br><span class="line">    String trackUrl = <span class="string">&quot;http://x.x.x/track&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注入配置集合</span></span><br><span class="line">    <span class="meta">@Inject(&quot;$&#123;track.db1&#125;&quot;)</span></span><br><span class="line">    Properties trackDbCfg;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注入Bean（根据对应的配置集合自动生成并注入）</span></span><br><span class="line">    <span class="meta">@Inject(&quot;$&#123;track.db1&#125;&quot;)</span></span><br><span class="line">    HikariDataSource trackDs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注入类"><a href="#注入类" class="headerlink" title="注入类"></a>注入类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject(&quot;$&#123;user.config&#125;&quot;)</span>  </span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProperties</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; tags;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@BindProps(prefix=&quot;user.config&quot;)</span>  <span class="comment">//或者用绑定属性注解。v3.0.7 后支持</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProperties</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; tags;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@BindProps(prefix=&quot;user.config&quot;)</span> <span class="comment">//或者用绑定属性注解。v3.0.7 后支持</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserProperties <span class="title">userProperties</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserProperties();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注入参数"><a href="#注入参数" class="headerlink" title="注入参数"></a>注入参数</h3><p>当注入到参数的时候，不支持自动刷新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configurationpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoConfig</span></span>&#123;</span><br><span class="line">    <span class="comment">//提示：@Bean 只能与 @Configuration 配合@Bean </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">db1</span><span class="params">(<span class="meta">@Inject(&quot;$&#123;track.db1&#125;&quot;)</span> HikariDataSource ds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ds;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Beanpublic</span> <span class="function">DataSourceWrap <span class="title">db1w</span><span class="params">(<span class="meta">@Inject</span> DataSource ds, <span class="meta">@Inject(&quot;$&#123;wrap&#125;&quot;)</span> WrapConfig wc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceWrap(ds, wc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//也可以带条件处理@Bean@Condition(onProperty=&quot;$&#123;cache.enable&#125; = true&quot;) //有 &quot;cache.enable&quot; 属性值，且等于truepublic CacheService cache(@Inject(&quot;$&#123;cache.config&#125;&quot;) CacheServiceSupplier supper)&#123;</span></span><br><span class="line">       <span class="keyword">return</span> supper.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自动更新"><a href="#自动更新" class="headerlink" title="自动更新"></a>自动更新</h3><p>自动刷新只适合于字段注入，以及单例的类。注意：<strong>如果不是单例，请不要开启自动刷新</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Componentpublic</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoService</span></span>&#123;</span><br><span class="line">    <span class="comment">//注入值（带默认值：demoApi），并开启自动更新</span></span><br><span class="line">    <span class="meta">@Inject(value=&quot;$&#123;track.name:demoApi&#125;&quot;, autoRefreshed=true)</span></span><br><span class="line">    String trackName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过函数时时获取最新的（静态或动态，按需设定）</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">trackName2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Solon.cfg().get(<span class="string">&quot;track.name:demoApi&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h2><p>通过 Solon.cfg() 获取 SolonProps 后进行操作。这里不做过多的描述，如果需要可以参看官网文档。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://solon.noear.org/article/31%EF%BC%8C%E6%89%8B%E5%8A%A8%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE%E5%8F%8A%E8%AE%A2%E9%98%85%E5%8F%98%E6%9B%B4%E7%9A%84%E5%86%85%E5%AE%B9%E3%80%82">https://solon.noear.org/article/31，手动获取配置及订阅变更的内容。</a></li>
<li><a target="_blank" rel="noopener" href="https://solon.noear.org/article/910%EF%BC%8CSolonProps">https://solon.noear.org/article/910，SolonProps</a> 接口参看</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>配置本身相关简单，记住对应的配置加载规则和注入的方法，基本不会有什么太多的问题。这里不对示例做过多说明，更多需要参看，参看具体的代码 demo-solon01 。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文主要主要介绍了 Solon 的配置配置规则和自动化配置的方法。在理解了 Solon 的配置后，就可以更动态的做部署的配置。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/16/course100/024/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/16/course100/024/" class="post-title-link" itemprop="url">Web 开发 —— 高阶 WebSocket 和 SSE</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-16 10:14:21 / 修改时间：10:15:45" itemprop="dateCreated datePublished" datetime="2025-02-16T10:14:21+08:00">2025-02-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>随着大语言模型的流行，因为使用了 SSE 或者 Websocket的技术进行流式的交换，使得 SSE 和 Websocket也火了起来，今天我们来讲解，如何在 Solon 中实现 Websocket  服务端和 SSE 服务端。</p>
<h2 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h2><p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。它使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<p>我们这里通过一个简易的 im 的服务做为例子。</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>如果使用了solon-web，默认使用的是smart-http，已经集成了 websocket，不需要添加其他的依赖。</p>
<table>
<thead>
<tr>
<th>插件</th>
<th>适配框架</th>
<th>包大小</th>
<th>信号协议支持</th>
<th>端口</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://solon.noear.org/article/90">solon-boot-smarthttp</a></td>
<td>smart-http (aio)</td>
<td>0.4Mb</td>
<td>http, ws</td>
<td>相同端口</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://solon.noear.org/article/91">solon-boot-jetty</a> + solon-boot-jetty-add-websocket</td>
<td>jetty (nio)</td>
<td>1.9Mb</td>
<td>http, ws</td>
<td>相同端口</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://solon.noear.org/article/92">solon-boot-undertow</a></td>
<td>undertow (nio)</td>
<td>4.3Mb</td>
<td>http, ws</td>
<td>相同端口</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://solon.noear.org/article/93">solon-boot-websocket</a></td>
<td>websocket (nio)</td>
<td>0.4Mb</td>
<td>ws</td>
<td>独立端口</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://solon.noear.org/article/551">solon-boot-websocket-netty</a></td>
<td>netty (nio)</td>
<td></td>
<td>ws</td>
<td>独立端口</td>
</tr>
</tbody></table>
<p>独立的 WebSocket 插件，会使用独立的端口，且默认为：主端口 + 10000，但都可以通过配置进行修改。</p>
<h3 id="启用"><a href="#启用" class="headerlink" title="启用"></a>启用</h3><p>在主类开启 Websocket。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.noear.solon.Solon;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.SolonMain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SolonMain</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoWeb05App</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Solon.start(</span><br><span class="line">        DemoWeb05App.class,</span><br><span class="line">        args,</span><br><span class="line">        app -&gt; &#123;</span><br><span class="line">          app.enableWebSocket(<span class="keyword">true</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开放端点"><a href="#开放端点" class="headerlink" title="开放端点"></a>开放端点</h3><p>这里集成了 SimpleWebSocketListener，已经提供了基本的实现，可以根据实际的需要实现需要的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.im.endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.im.service.ImService;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Inject;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.net.annotation.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.net.websocket.WebSocket;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.net.websocket.listener.SimpleWebSocketListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/im.ws&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImWebsocket</span> <span class="keyword">extends</span> <span class="title">SimpleWebSocketListener</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> ImService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(WebSocket socket)</span> </span>&#123;</span><br><span class="line">    service.onOpen(socket);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(WebSocket socket, String text)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    service.onMessage(socket, text);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现逻辑"><a href="#实现逻辑" class="headerlink" title="实现逻辑"></a>实现逻辑</h3><p>此处只是做简单的鉴权，和消息的回复，如果要实现完整的 IM 服务，还需要做会话的管理的逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.im.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> org.dromara.hutool.core.text.StrUtil;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.net.websocket.WebSocket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(WebSocket socket)</span> </span>&#123;</span><br><span class="line">    String token = socket.param(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">      socket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略了管理 socket 的管理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(WebSocket socket, String text)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    socket.send(<span class="string">&quot;&gt; &quot;</span> + text + <span class="string">&quot;\r\n&quot;</span> + <span class="string">&quot;消息已阅&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=N2U0ZmI3YjBjOWVjOGE4ZDdjOTNkN2ViZTA1MzkyMmFfNTZ0aUlXbzVyZG5hcUNMMFhOY1h6aUlhZ255MllqVllfVG9rZW46Skg1YmI5VmlMb21ydGd4OTJZMmMxQVBHbjJlXzE3Mzk2NzIxMDg6MTczOTY3NTcwOF9WNA" alt="img"></p>
<h2 id="SSE"><a href="#SSE" class="headerlink" title="SSE"></a>SSE</h2><p>SSE 全称是 Server-Sent Event，网页自动获取来自服务器的更新，SSE 是单向消息传递。</p>
<p>我们这里通过一个简易的 LLM 的服务做为例子。</p>
<h3 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h3><p>要实现 SSE 需要引入 solon-web-sse。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="function">implementation <span class="title">platform</span><span class="params">(project(<span class="string">&quot;:demo-parent&quot;</span>)</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">implementation</span><span class="params">(<span class="string">&quot;org.noear:solon-web&quot;</span>)</span></span></span><br><span class="line"><span class="function">    <span class="title">implementation</span><span class="params">(<span class="string">&quot;org.noear:solon-web-sse&quot;</span>)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="开放端点-1"><a href="#开放端点-1" class="headerlink" title="开放端点"></a>开放端点</h3><p>客户端先要调用 open 方法，初始化 SseEmitter 连接，之后就可以通过 SseEmitter 给客户端发送消息了，为了方便测试这里还提供了 send 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.chat.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.chat.service.ChatService;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Controller;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Inject;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.web.sse.SseEmitter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/chat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> ChatService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(value = &quot;/open/&#123;id&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SseEmitter <span class="title">open</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.open(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;/send/&#123;id&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.send(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;/close/&#123;id&#125;&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">close</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.close(id);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现逻辑-1"><a href="#实现逻辑-1" class="headerlink" title="实现逻辑"></a>实现逻辑</h3><p>与 Websocket 不同的是，SSE 是单向连接，请求的过程是不带会话连接的，所以需要自己管理好会话。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.chat.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.snack.ONode;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.Utils;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Result;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.web.sse.SseEmitter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.web.sse.SseEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Map&lt;String, SseEmitter&gt; emitterMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SseEmitter <span class="title">open</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    SseEmitter sseEmitter =</span><br><span class="line">        <span class="keyword">new</span> SseEmitter(<span class="number">60</span> * <span class="number">1000L</span>)</span><br><span class="line">            .onCompletion(() -&gt; emitterMap.remove(id))</span><br><span class="line">            .onError(e -&gt; log.error(<span class="string">&quot;初始化 sse 错误&quot;</span>, e))</span><br><span class="line">            .onInited(s -&gt; emitterMap.put(id, s));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      sseEmitter.send(<span class="string">&quot;Ok&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;发送 sse 错误&quot;</span>, e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化后，才能使用</span></span><br><span class="line">    <span class="keyword">return</span> sseEmitter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    SseEmitter emitter = emitterMap.get(id);</span><br><span class="line">    <span class="keyword">if</span> (emitter == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;No user: &quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String msg = <span class="string">&quot;test msg -&gt; &quot;</span> + System.currentTimeMillis();</span><br><span class="line">    System.out.println(msg);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      emitter.send(msg);</span><br><span class="line">      <span class="comment">// reconnectTime 用于提示前端重连时间</span></span><br><span class="line">      emitter.send(<span class="keyword">new</span> SseEvent().id(Utils.guid()).data(msg).reconnectTime(<span class="number">1000L</span>));</span><br><span class="line">      emitter.send(ONode.stringify(Result.succeed(msg)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;发送 sse 错误&quot;</span>, e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Ok&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">close</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    SseEmitter emitter = emitterMap.get(id);</span><br><span class="line">    <span class="keyword">if</span> (emitter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      emitter.complete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Ok&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>ApiFox 支持测试 SSE，连接成功之后就可以调用 send 方法。</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=Nzk1OTVkMjM1Y2JkNTYzNjM2NzE2NmUzOGNhOWY0YzdfT3V4MUVvWkp4ZGswNFl5SjJ3ZHV2bExjakZjUFk3N1VfVG9rZW46SkFHV2JJbHhUb1lZQ3l4UnhNRGNGZUtabktjXzE3Mzk2NzIxMDg6MTczOTY3NTcwOF9WNA" alt="img"></p>
<p>也可以直接使用 curl 进行测试</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=NDk5NTNlOGQ3NDM1ZDAxMjc3MjBhYmYwZDI1ZjkxYWJfWDlaaU1PWkpNUlN6d3lHemo0WklhY3R2eldrMWxxVklfVG9rZW46VzVUc2IzSmpEbzBHelR4ZHNCcWNIZHV4bmZjXzE3Mzk2NzIxMDg6MTczOTY3NTcwOF9WNA" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/15/course100/023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/15/course100/023/" class="post-title-link" itemprop="url">Web 开发 —— 高阶 本地网关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-15 20:30:26 / 修改时间：20:34:06" itemprop="dateCreated datePublished" datetime="2025-02-15T20:30:26+08:00">2025-02-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>这里说本地网关，主要是为了区分分布式网关。</p>
<p>在 Web 进阶中，我们讲解了如何定制过滤器和拦截器，提到 Action 本质上是 Handler 和 Class Method 的结合通过，今天我们要讲解一种特殊的Handler —— Gateway（本地网关），通过本地网关更统一的定制系统功能，比如二级路由、拦截、过滤、熔断、异常处理等，虽然直接使用过滤器，也可以做统一的鉴权和异常处理，但网关还可以把一批接口编排进多个网关中，从而实现不同的协议。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>在 IDEA 中通过 <code>File-&gt;New-&gt;Modules...</code> 可以创建新的模块 <code>demo-web04</code>，基础代码和配置可以从<code>demo-web02</code>中拷贝过来。</p>
<p>在这里，我们将继续调整<code>demo-web02</code>，通过 Gateway 来统一的控制逻辑。</p>
<ul>
<li>增加路由分组，<code>/admin-api/**</code> 对应管理端接口，<code>/app-api/**</code>对应应用端接口</li>
<li>不同的路由分组使用不同的过滤器，从而实现不同的协议等。</li>
</ul>
<h3 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h3><h4 id="BaseGateway"><a href="#BaseGateway" class="headerlink" title="BaseGateway"></a>BaseGateway</h4><p>通过 Component 的标签来添加过滤器的通用逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.gateway;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.Solon;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.BeanWrap;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Filter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Gateway;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseGateway</span> <span class="keyword">extends</span> <span class="title">Gateway</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilters</span><span class="params">(Predicate&lt;BeanWrap&gt; where)</span> </span>&#123;</span><br><span class="line">    Solon.context()</span><br><span class="line">        .lifecycle(</span><br><span class="line">            () -&gt;</span><br><span class="line">                Solon.context()</span><br><span class="line">                    .beanForeach(</span><br><span class="line">                        (bw) -&gt; &#123;</span><br><span class="line">                          <span class="keyword">if</span> (where.test(bw)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (bw.raw() <span class="keyword">instanceof</span> Filter) &#123;</span><br><span class="line">                              filter(bw.index(), bw.raw());</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SwaggerConfig"><a href="#SwaggerConfig" class="headerlink" title="SwaggerConfig"></a>SwaggerConfig</h4><p>对 /admin-api 和 /app-api 的文档进行分组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.xiaoymin.knife4j.solon.extension.OpenApiExtensionResolver;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.Scheme;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.ApiKeyAuthDefinition;</span><br><span class="line"><span class="keyword">import</span> io.swagger.models.auth.In;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"><span class="keyword">import</span> org.dromara.hutool.core.text.StrUtil;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.Solon;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Inject;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.BeanWrap;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.docs.DocDocket;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.docs.models.ApiContact;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.docs.models.ApiInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> OpenApiExtensionResolver openApiExtensionResolver;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean(&quot;adminApi&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DocDocket <span class="title">adminApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DocDocket docDocket =</span><br><span class="line">        <span class="keyword">new</span> DocDocket()</span><br><span class="line">            .groupName(<span class="string">&quot;Admin 端接口&quot;</span>)</span><br><span class="line">            .info(</span><br><span class="line">                <span class="keyword">new</span> ApiInfo()</span><br><span class="line">                    .title(<span class="string">&quot;porpoise-demo&quot;</span>)</span><br><span class="line">                    .description(<span class="string">&quot;在线API文档&quot;</span>)</span><br><span class="line">                    .contact(<span class="keyword">new</span> ApiContact().name(<span class="string">&quot;CrazyAirhead&quot;</span>).email(<span class="string">&quot;l4qiang@hotmail.com&quot;</span>))</span><br><span class="line">                    .version(<span class="string">&quot;1.0&quot;</span>))</span><br><span class="line">            .schemes(Scheme.HTTP.toValue())</span><br><span class="line">            .globalResponseInData(<span class="keyword">true</span>)</span><br><span class="line">            .basePath(getBasePath())</span><br><span class="line">            .vendorExtensions(openApiExtensionResolver.buildExtensions())</span><br><span class="line">            .securityExtensions(<span class="string">&quot;token&quot;</span>, <span class="keyword">new</span> ApiKeyAuthDefinition().name(<span class="string">&quot;token&quot;</span>).in(In.HEADER));</span><br><span class="line"></span><br><span class="line">    addApis(docDocket, bw -&gt; <span class="string">&quot;adminApi&quot;</span>.equals(bw.tag()));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> docDocket;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean(&quot;appApi&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DocDocket <span class="title">appApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DocDocket docDocket =</span><br><span class="line">        <span class="keyword">new</span> DocDocket()</span><br><span class="line">            .groupName(<span class="string">&quot;app 端接口&quot;</span>)</span><br><span class="line">            .info(</span><br><span class="line">                <span class="keyword">new</span> ApiInfo()</span><br><span class="line">                    .title(<span class="string">&quot;Ficus&quot;</span>)</span><br><span class="line">                    .description(<span class="string">&quot;在线App API文档&quot;</span>)</span><br><span class="line">                    .termsOfService(<span class="string">&quot;https://jishunetwork.com&quot;</span>)</span><br><span class="line">                    .contact(</span><br><span class="line">                        <span class="keyword">new</span> ApiContact()</span><br><span class="line">                            .name(<span class="string">&quot;Ficus&quot;</span>)</span><br><span class="line">                            .url(<span class="string">&quot;https://jishunetwork.com&quot;</span>)</span><br><span class="line">                            .email(<span class="string">&quot;l4qiang@gmail.com&quot;</span>))</span><br><span class="line">                    .version(<span class="string">&quot;1.0&quot;</span>))</span><br><span class="line">            .schemes(Scheme.HTTP.toValue())</span><br><span class="line">            .globalResponseInData(<span class="keyword">true</span>)</span><br><span class="line">            .basePath(getBasePath());</span><br><span class="line"></span><br><span class="line">    addApis(docDocket, bw -&gt; <span class="string">&quot;appApi&quot;</span>.equals(bw.tag()));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> docDocket;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getBasePath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String basePath = Solon.cfg().serverContextPath();</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(basePath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (basePath.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">      basePath = basePath.substring(<span class="number">0</span>, basePath.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> basePath;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addApis</span><span class="params">(DocDocket docDocket, Predicate&lt;BeanWrap&gt; where)</span> </span>&#123;</span><br><span class="line">    Solon.context()</span><br><span class="line">        .lifecycle(</span><br><span class="line">            () -&gt;</span><br><span class="line">                Solon.context()</span><br><span class="line">                    .beanForeach(</span><br><span class="line">                        bw -&gt; &#123;</span><br><span class="line">                          <span class="keyword">if</span> (where.test(bw)) &#123;</span><br><span class="line">                            String name = bw.clz().getName();</span><br><span class="line">                            docDocket.apis(name);</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="管理端"><a href="#管理端" class="headerlink" title="管理端"></a>管理端</h3><h4 id="AdminGateway"><a href="#AdminGateway" class="headerlink" title="AdminGateway"></a>AdminGateway</h4><p>路由注册，添加 adminApi 标签的过滤器，添加 adminApi 标签的请求方法。除了按批添加接口，还可以单独添加，这里未单独列出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.gateway;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/admin-api/**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminGateway</span> <span class="keyword">extends</span> <span class="title">BaseGateway</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 添加过滤器</span></span><br><span class="line">    addFilters(beanWrap -&gt; <span class="string">&quot;adminApi&quot;</span>.equals(beanWrap.tag()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加接口</span></span><br><span class="line">    addBeans(beanWrap -&gt; <span class="string">&quot;adminApi&quot;</span>.equals(beanWrap.tag()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AdminExceptionFilter"><a href="#AdminExceptionFilter" class="headerlink" title="AdminExceptionFilter"></a>AdminExceptionFilter</h4><p>增加 adminApi 的标签，delivered设置为false，这样不会被加载为全局的路由，index设置为-1，提供有限级。为了区分与 App 端的不同，这里的的错误会返回异常的具体信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.model.Ret;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Filter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.FilterChain;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.validation.ValidatorException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(tag = &quot;adminApi&quot;, delivered = false, index = -1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminExceptionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Context ctx, FilterChain chain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      chain.doFilter(ctx);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ValidatorException e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;validator exception&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">      ctx.status(e.getCode());</span><br><span class="line">      ctx.outputAsJson(Ret.fail(e.getMessage()).toJson());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;other throwable&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">      ctx.status(<span class="number">500</span>);</span><br><span class="line">      ctx.outputAsJson(Ret.fail(e.getMessage()).toJson());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 文件清理放此处也算合理，异常时需要清理和尝试恢复</span></span><br><span class="line">      <span class="keyword">if</span> (ctx.isMultipartFormData()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          ctx.filesDelete();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          log.error(<span class="string">&quot;clean temp file exception&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AdminTokenFilter"><a href="#AdminTokenFilter" class="headerlink" title="AdminTokenFilter"></a>AdminTokenFilter</h4><p>管理端需要 token 校验，这里也是为了演示通过不同的 Gateway 可以有不同的过滤器的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.dromara.hutool.core.text.StrUtil;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Filter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.FilterChain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(tag = &quot;adminApi&quot;, delivered = false, index = 0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminTokenFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Context ctx, FilterChain chain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String token = ctx.header(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;token 不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chain.doFilter(ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DeptController"><a href="#DeptController" class="headerlink" title="DeptController"></a>DeptController</h4><p>这里的 Controller 去除了 @Controller 的注解和 @Mapping 的注解，使用的是 @Component 的注解，并设置了adminApi的标签，以便 AdminGateway 能进行批量的添加。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.manage.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.annotation.OperateLog;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.model.Ret;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.manage.dto.DeptDto;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.manage.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(tag = &quot;adminApi&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;管理端 部门管理&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> DeptService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(value = &quot;listWithException&quot;)</span></span><br><span class="line">  <span class="meta">@Get</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;获取列表但返回异常&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> Ret&lt;List&lt;DeptDto&gt;&gt; listWithException() &#123;</span><br><span class="line">    <span class="keyword">return</span> Ret.ok(service.listWithException());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(value = &quot;list&quot;)</span></span><br><span class="line">  <span class="meta">@Get</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;获取列表&quot;)</span></span><br><span class="line">  <span class="meta">@OperateLog</span></span><br><span class="line">  <span class="keyword">public</span> Ret&lt;List&lt;DeptDto&gt;&gt; list() &#123;</span><br><span class="line">    <span class="keyword">return</span> Ret.ok(service.list());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应用端"><a href="#应用端" class="headerlink" title="应用端"></a>应用端</h3><h4 id="AppGateway"><a href="#AppGateway" class="headerlink" title="AppGateway"></a>AppGateway</h4><p>路由注册，添加 appApi 标签的过滤器，添加 appApi 标签的请求方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.gateway;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Mapping;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/app-api/**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppGateway</span> <span class="keyword">extends</span> <span class="title">BaseGateway</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 添加过滤器</span></span><br><span class="line">    addFilters(beanWrap -&gt; <span class="string">&quot;appApi&quot;</span>.equals(beanWrap.tag()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加接口</span></span><br><span class="line">    addBeans(beanWrap -&gt; <span class="string">&quot;appApi&quot;</span>.equals(beanWrap.tag()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AppExceptionFilter"><a href="#AppExceptionFilter" class="headerlink" title="AppExceptionFilter"></a>AppExceptionFilter</h4><p>Component增加 appApi 的标签，delivered设置为false，这样不会被加载为全局的路由，index设置为-1，提高优先级。为了区分与 Admin 端的不同，这里的的错误只返回「服务器错误，请重试」这样的错误信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.model.Ret;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Filter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.FilterChain;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.validation.ValidatorException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * App</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component(tag = &quot;appApi&quot;, delivered = false, index = -1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppExceptionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Context ctx, FilterChain chain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      chain.doFilter(ctx);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ValidatorException e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;validator exception&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">      ctx.status(e.getCode());</span><br><span class="line">      ctx.outputAsJson(Ret.fail(<span class="string">&quot;服务器错误，请重试&quot;</span>).toJson());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      log.error(<span class="string">&quot;other throwable&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">      ctx.status(<span class="number">500</span>);</span><br><span class="line">      ctx.outputAsJson(Ret.fail(<span class="string">&quot;服务器错误，请重试&quot;</span>).toJson());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 文件清理放此处也算合理，异常时需要清理和尝试恢复</span></span><br><span class="line">      <span class="keyword">if</span> (ctx.isMultipartFormData()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          ctx.filesDelete();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          log.error(<span class="string">&quot;clean temp file exception&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AppDeptController"><a href="#AppDeptController" class="headerlink" title="AppDeptController"></a>AppDeptController</h4><p>这里的 Controller 去除了 @Controller 的注解和 @Mapping 的注解，使用的是 @Component 的注解，并设置了appApi的标签，以便 AdminGateway 能进行批量的添加。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.manage.controller.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.manage.dto.DeptDto;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.manage.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component(tag = &quot;appApi&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;App 端部门服务&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDeptController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> DeptService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(value = &quot;listWithException&quot;)</span></span><br><span class="line">  <span class="meta">@Get</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;获取列表但返回异常&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;DeptDto&gt; <span class="title">listWithException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.listWithException();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(value = &quot;list&quot;)</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;获取列表&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;DeptDto&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.list();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;/index&quot;)</span></span><br><span class="line">  <span class="meta">@Get</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;浏览部门&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.put(<span class="string">&quot;depts&quot;</span>, service.list());</span><br><span class="line">    mv.view(<span class="string">&quot;dept.shtm&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><h4 id="管理端接口请求"><a href="#管理端接口请求" class="headerlink" title="管理端接口请求"></a>管理端接口请求</h4><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=OTU1ZDJjNzA1Nzg4NGE4NjVmMTI4MzZkMzZmNjdhOGJfdVRtSHBxVVJ4Q1Vhc0NWaHV5bXNTQ1V3bkM0Vzk2azlfVG9rZW46R2NLWmJDaVhyb1p1RkJ4WFlrSWNvNFQ3bmJiXzE3Mzk2MjI2Njg6MTczOTYyNjI2OF9WNA" alt="img"></p>
<h4 id="应用端接口请求"><a href="#应用端接口请求" class="headerlink" title="应用端接口请求"></a>应用端接口请求</h4><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjdmYzFhMmRlYTNjNDRmMTM0OWY0MzBkZmEzYjI1ZmJfV0VZQ1QxTmtKUWRaUk1sYWRZekVnbjRoTkVQT3VLZ1BfVG9rZW46TDIzOGJJcXdob1JocXl4ZXo5UGNVODJPbnJlXzE3Mzk2MjI2Njg6MTczOTYyNjI2OF9WNA" alt="img"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本章通过本地网关对路由分组注册的方式演示了统一的异常处理和鉴权的逻辑，其实 Gateway 还能进一步的定制，可以参考官网的文档 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/214">https://solon.noear.org/article/214</a> 。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/14/course100/022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/14/course100/022/" class="post-title-link" itemprop="url">Web 开发 —— 进阶 事务和缓存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-02-14 22:44:04 / 修改时间：22:53:47" itemprop="dateCreated datePublished" datetime="2025-02-14T22:44:04+08:00">2025-02-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>在数据操作的章节中，我们只是讲解了对关系数据库和非关系数据库的简单的数据操作，在实际的业务当中，操作会更加复杂，因此不可避免的会涉及到数据库的事务和数据的缓存。</p>
<p>Solon 通过 Solon data 提供事务的管理和基础的缓存框架，具体的缓存实现还是通过插件的方式来实现的。</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>Solon 的事务是通过 AOP 的方式实现的，因此在同一个类中的两个方法的调用，事务传播机制是不会生效的。</p>
<p>Solon 通过 Tran 注解来标记事务，主要有 policy （事务传导策略）和 isolation（事务隔离级别）</p>
<h3 id="事务传导策略"><a href="#事务传导策略" class="headerlink" title="事务传导策略"></a>事务传导策略</h3><table>
<thead>
<tr>
<th>传番策略</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>TranPolicy.required</td>
<td>支持当前事务，如果没有则创建一个新的。这是最常见的选择。也是默认。</td>
</tr>
<tr>
<td>TranPolicy.requires_new</td>
<td>新建事务，如果当前存在事务，把当前事务挂起。</td>
</tr>
<tr>
<td>TranPolicy.nested</td>
<td>如果当前有事务，则在当前事务内部嵌套一个事务；否则新建事务。</td>
</tr>
<tr>
<td>TranPolicy.mandatory</td>
<td>支持当前事务，如果没有事务则报错。</td>
</tr>
<tr>
<td>TranPolicy.supports</td>
<td>支持当前事务，如果没有则不使用事务。</td>
</tr>
<tr>
<td>TranPolicy.not_supported</td>
<td>以无事务的方式执行，如果当前有事务则将其挂起。</td>
</tr>
<tr>
<td>TranPolicy.never</td>
<td>以无事务的方式执行，如果当前有事务则报错。</td>
</tr>
</tbody></table>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>TranIsolation.unspecified</td>
<td>默认（JDBC默认）</td>
</tr>
<tr>
<td>TranIsolation.read_uncommitted</td>
<td>脏读：其它事务，可读取未提交数据</td>
</tr>
<tr>
<td>TranIsolation.read_committed</td>
<td>只读取提交数据：其它事务，只能读取已提交数据</td>
</tr>
<tr>
<td>TranIsolation.repeatable_read</td>
<td>可重复读：保证在同一个事务中多次读取同样数据的结果是一样的</td>
</tr>
<tr>
<td>TranIsolation.serializable</td>
<td>可串行化读：要求事务串行化执行，事务只能一个接着一个执行，不能并发执行</td>
</tr>
</tbody></table>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>虽然 Solon 支持手动的方式提供对事务的操作，但用注解的方式已经足够用，所以这里就不讲解手动使用的方式。如果需要可以查看官网文档 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/299">https://solon.noear.org/article/299</a> 。官网也提供了事务的监听器，可能针对性的对事务的事件做些附加的处理。</p>
<p>基于 Web02 增加用户表（主表）和用户部门表（子表）来演示事务的三个常见：</p>
<ol>
<li>回滚，无论添加主表方法异常，还是添加子表方法异常。在这个例子业务数据正常。</li>
<li>只回滚父事务，但不回滚子事务。也就是主表不会添加数据，子表会添加数据。在这个例子中表现为业务数据异常。</li>
<li>只回滚子事务，但不回滚父事务。也就是子表不会添加数据，父表会添加数据。在这个例子中表现为业务数据异常。</li>
</ol>
<p>为了方便说明和查看方便，不同的回滚场景提供的代码会做删减，请注意到仓库获取完整代码。</p>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `demo_user` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `nick_name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">  `user_name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  `create_at` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_at` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  `creator` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建人&#x27;</span>,</span><br><span class="line">  `updater` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新人&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci COMMENT<span class="operator">=</span><span class="string">&#x27;用户表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `demo_user_dept` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `dept_id` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;部门id&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>

<h4 id="回滚主子表"><a href="#回滚主子表" class="headerlink" title="回滚主子表"></a>回滚主子表</h4><p>回滚主子表的时候，可能出现两种情况，一种是子表方法出现错误，一种是主表方法出现问题。</p>
<h5 id="UserController"><a href="#UserController" class="headerlink" title="UserController"></a>UserController</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;用户管理&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> UserService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;rollbackAll&quot;)</span></span><br><span class="line">  <span class="meta">@Post</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;回滚全部&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackAll</span><span class="params">(<span class="meta">@Body</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">    service.rollbackAll(userDto);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;rollbackAll1&quot;)</span></span><br><span class="line">  <span class="meta">@Post</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;回滚全部1&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackAll1</span><span class="params">(<span class="meta">@Body</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.rollbackAll1(userDto);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserService"><a href="#UserService" class="headerlink" title="UserService"></a>UserService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> UserDeptService userDeptService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollbackAll</span><span class="params">(UserDto userDto)</span> </span>&#123;</span><br><span class="line">    UserEntity user = UserConvert.INSTANCE.convert(userDto);</span><br><span class="line"></span><br><span class="line">    entityQuery.insertable(user).executeRows(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    UserDeptDto userDeptDto = <span class="keyword">new</span> UserDeptDto();</span><br><span class="line">    userDeptDto.setUserId(user.getId());</span><br><span class="line">    userDeptDto.setDeptId(userDto.getDeptId());</span><br><span class="line">    <span class="comment">// 子表方法异常</span></span><br><span class="line">    userDeptService.rollbackUserDept(userDeptDto);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackAll1</span><span class="params">(UserDto userDto)</span> </span>&#123;</span><br><span class="line">    UserEntity user = UserConvert.INSTANCE.convert(userDto);</span><br><span class="line"></span><br><span class="line">    entityQuery.insertable(user).executeRows(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    UserDeptDto userDeptDto = <span class="keyword">new</span> UserDeptDto();</span><br><span class="line">    userDeptDto.setUserId(user.getId());</span><br><span class="line">    userDeptDto.setDeptId(userDto.getDeptId());</span><br><span class="line">    userDeptService.addUserDept(userDeptDto);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主表方法异常</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;不能添加主表&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserDeptService"><a href="#UserDeptService" class="headerlink" title="UserDeptService"></a>UserDeptService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDeptService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUserDept</span><span class="params">(UserDeptDto userDeptDto)</span> </span>&#123;</span><br><span class="line">    UserDeptEntity userDept = UserDeptConvert.INSTANCE.convert(userDeptDto);</span><br><span class="line">    entityQuery.insertable(userDept).executeRows(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackUserDept</span><span class="params">(UserDeptDto userDeptDto)</span> </span>&#123;</span><br><span class="line">    UserDeptEntity userDept = UserDeptConvert.INSTANCE.convert(userDeptDto);</span><br><span class="line">    entityQuery.insertable(userDept).executeRows(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;不能添加子表&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h5><p>这里就不截图了，可以从日志和看数据库数据，可以看到 user 表和 user_dept 表都不会增加数据。</p>
<h4 id="只回滚主表，但不回滚子表"><a href="#只回滚主表，但不回滚子表" class="headerlink" title="只回滚主表，但不回滚子表"></a>只回滚主表，但不回滚子表</h4><h5 id="UserController-1"><a href="#UserController-1" class="headerlink" title="UserController"></a>UserController</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;用户管理&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> UserService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;rollbackMaster&quot;)</span></span><br><span class="line">  <span class="meta">@Post</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;回滚主表&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackMaster</span><span class="params">(<span class="meta">@Body</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">    service.rollbackMaster(userDto);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserService-1"><a href="#UserService-1" class="headerlink" title="UserService"></a>UserService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> UserDeptService userDeptService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollbackMaster</span><span class="params">(UserDto userDto)</span> </span>&#123;</span><br><span class="line">    UserEntity user = UserConvert.INSTANCE.convert(userDto);</span><br><span class="line"></span><br><span class="line">    entityQuery.insertable(user).executeRows(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    UserDeptDto userDeptDto = <span class="keyword">new</span> UserDeptDto();</span><br><span class="line">    userDeptDto.setUserId(user.getId());</span><br><span class="line">    userDeptDto.setDeptId(userDto.getDeptId());</span><br><span class="line"></span><br><span class="line">    userDeptService.addUserDept1(userDeptDto);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;不能添加主表&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserDeptService-1"><a href="#UserDeptService-1" class="headerlink" title="UserDeptService"></a>UserDeptService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDeptService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran(policy = TranPolicy.requires_new)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUserDept1</span><span class="params">(UserDeptDto userDeptDto)</span> </span>&#123;</span><br><span class="line">    UserDeptEntity userDept = UserDeptConvert.INSTANCE.convert(userDeptDto);</span><br><span class="line">    entityQuery.insertable(userDept).executeRows(<span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h5><p>这里就不截图了，可以从日志和看数据库数据，可以看到 user 表不会增加数据，但 user_dept 表会增加数据。</p>
<h4 id="只回滚子表，但不回滚主表"><a href="#只回滚子表，但不回滚主表" class="headerlink" title="只回滚子表，但不回滚主表"></a>只回滚子表，但不回滚主表</h4><h5 id="UserController-2"><a href="#UserController-2" class="headerlink" title="UserController"></a>UserController</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;用户管理&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> UserService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;rollbackSub&quot;)</span></span><br><span class="line">  <span class="meta">@Post</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;回滚子表&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackSub</span><span class="params">(<span class="meta">@Body</span> UserDto userDto)</span> </span>&#123;</span><br><span class="line">    service.rollbackSub(userDto);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserService-2"><a href="#UserService-2" class="headerlink" title="UserService"></a>UserService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> UserDeptService userDeptService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollbackSub</span><span class="params">(UserDto userDto)</span> </span>&#123;</span><br><span class="line">    UserEntity user = UserConvert.INSTANCE.convert(userDto);</span><br><span class="line"></span><br><span class="line">    entityQuery.insertable(user).executeRows(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    UserDeptDto userDeptDto = <span class="keyword">new</span> UserDeptDto();</span><br><span class="line">    userDeptDto.setUserId(user.getId());</span><br><span class="line">    userDeptDto.setDeptId(userDto.getDeptId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      userDeptService.rollbackUserDept1(userDeptDto);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">      <span class="comment">// 忽略子表的异常</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserDeptService-2"><a href="#UserDeptService-2" class="headerlink" title="UserDeptService"></a>UserDeptService</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDeptService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Tran(policy = TranPolicy.nested)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">rollbackUserDept1</span><span class="params">(UserDeptDto userDeptDto)</span> </span>&#123;</span><br><span class="line">    UserDeptEntity userDept = UserDeptConvert.INSTANCE.convert(userDeptDto);</span><br><span class="line">    entityQuery.insertable(userDept).executeRows(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;不能添加子表&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="效果-2"><a href="#效果-2" class="headerlink" title="效果"></a>效果</h5><p>这里就不截图了，可以从日志和看数据库数据，可以看到 user 表会添加数据，但 user_dept 表不会添加数据。</p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p>Solon 通过 solon-data 插件提供缓存的基础框架，然后通过不同的缓存插件实现具体的缓存逻辑，使得应用层可以快速的切换缓存的存储或者实现多级缓存。</p>
<p>Solon 的缓存框架使用 key（唯一标识） 和 tags（标签）两个维度来管理缓存。</p>
<ul>
<li>key ：缓存唯一标识，没有指定时会自动生成。无论自己指定还是自动生成都需要注意避免 key 重复。</li>
<li>tags：缓存标签，可以用于标签的批量操作，通常为批量删除。</li>
</ul>
<h3 id="注解说明"><a href="#注解说明" class="headerlink" title="注解说明"></a>注解说明</h3><p>@Cache 注解：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>service()</td>
<td>缓存服务</td>
</tr>
<tr>
<td>seconds()</td>
<td>缓存时间</td>
</tr>
<tr>
<td>key()</td>
<td>缓存唯一标识，支持字符串模版</td>
</tr>
<tr>
<td>tags()</td>
<td>缓存标签，多个以逗号隔开（为当前缓存块添加标签，用于清除）</td>
</tr>
</tbody></table>
<p>@CachePut 注解：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>service()</td>
<td>缓存服务</td>
</tr>
<tr>
<td>seconds()</td>
<td>缓存时间</td>
</tr>
<tr>
<td>key()</td>
<td>缓存唯一标识，支持字符串模版</td>
</tr>
<tr>
<td>tags()</td>
<td>缓存标签，多个以逗号隔开（为当前缓存块添加标签，用于清除）</td>
</tr>
</tbody></table>
<p>@CacheRemove 注解：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>service()</td>
<td>缓存服务</td>
</tr>
<tr>
<td>keys()</td>
<td>缓存唯一标识，多个以逗号隔开，支持字符串模版</td>
</tr>
<tr>
<td>tags()</td>
<td>缓存标签，多个以逗号隔开（方便清除一批key）</td>
</tr>
</tbody></table>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>我们继续通过部门管理的例子来演示数据的缓存。</p>
<h4 id="RedisConfig"><a href="#RedisConfig" class="headerlink" title="RedisConfig"></a>RedisConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean(typed = true)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CacheService <span class="title">defaultCache</span><span class="params">(<span class="meta">@Inject</span> RedisClient redisClient)</span> </span>&#123;</span><br><span class="line">    RedisCacheService cacheService = <span class="keyword">new</span> RedisCacheService(redisClient, <span class="number">30</span>);</span><br><span class="line">    cacheService.enableMd5key(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> cacheService;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean(typed = true)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RedisClient <span class="title">defaultClient</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Inject(&quot;$&#123;demo.redis&#125;&quot;)</span> RedisClientSupplier redisClientSupplier)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> redisClientSupplier.get();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DeptDto"><a href="#DeptDto" class="headerlink" title="DeptDto"></a>DeptDto</h4><p>需要实现 Serializable 这样才能给缓存序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ApiModel</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptDto</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 部门名称 */</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 部门编码 */</span></span><br><span class="line">  <span class="keyword">private</span> String code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DeptService"><a href="#DeptService" class="headerlink" title="DeptService"></a>DeptService</h4><p>保存、更新、删除的时候通过tags清理缓存，获取id和list的时候通过key增加缓存，同时增加tags标签。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Db(&quot;db1&quot;)</span></span><br><span class="line">  <span class="keyword">private</span> EasyEntityQuery entityQuery;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CachePut(key = &quot;dept:list&quot;, tags = &quot;dept&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;DeptDto&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;search list from db&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entityQuery.queryable(DeptEntity.class).select(DeptDto.class).toList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CacheRemove(tags = &quot;dept&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">add</span><span class="params">(DeptDto deptDto)</span> </span>&#123;</span><br><span class="line">    DeptEntity dept = DeptConvert.INSTANCE.convert(deptDto);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entityQuery.insertable(dept).executeRows(<span class="keyword">true</span>) &gt; <span class="number">0L</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CacheRemove(tags = &quot;dept&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">update</span><span class="params">(DeptDto deptDto)</span> </span>&#123;</span><br><span class="line">    DeptEntity dept = DeptConvert.INSTANCE.convert(deptDto);</span><br><span class="line">    <span class="keyword">return</span> entityQuery.updatable(dept).executeRows() &gt; <span class="number">0L</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CachePut(key = &quot;dept:$&#123;id&#125;&quot;, tags = &quot;dept&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> DeptDto <span class="title">get</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;search from db by id&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entityQuery</span><br><span class="line">        .queryable(DeptEntity.class)</span><br><span class="line">        .whereById(id)</span><br><span class="line">        .select(DeptDto.class)</span><br><span class="line">        .firstOrNull();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@CacheRemove(tags = &quot;dept&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">delete</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> entityQuery</span><br><span class="line">            .getEasyQueryClient()</span><br><span class="line">            .deletable(DeptEntity.class)</span><br><span class="line">            .allowDeleteStatement(<span class="keyword">true</span>)</span><br><span class="line">            .whereById(id)</span><br><span class="line">            .executeRows()</span><br><span class="line">        &gt; <span class="number">0L</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="效果-3"><a href="#效果-3" class="headerlink" title="效果"></a>效果</h4><p>调用 list 或 get 接口时缓存，如果存在缓存时不再从数据库中获取数据。</p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=M2Y1NDEwYmMwMDlkMTNkMTk1MDVhYTIyOWE5MTgwMTlfTVJDNkQwYWpLdXpXTVM4ekhVRWpxenJRMXhiczVkS3NfVG9rZW46QzVCZWJYV1RNb3Q2OUd4a01MVGNyY0pHblMzXzE3Mzk1NDQzNjE6MTczOTU0Nzk2MV9WNA" alt="img"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>要在 Solon 应用中使用事务和缓存是比较容易的，增加对应的注解即可实现相关的功能。有了事务和缓存的支持，数据的可靠性和应用的性能可以进一步得到保障，通过以上内容的学习，基本上可以起飞，做业务开发了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://l4qiang.me/2025/02/13/course100/021/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="L4qiang">
      <meta itemprop="description" content="记录点滴，注重积累。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CrazyAirhead">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/13/course100/021/" class="post-title-link" itemprop="url">Web 开发 —— 进阶</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-02-13 19:50:30" itemprop="dateCreated datePublished" datetime="2025-02-13T19:50:30+08:00">2025-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-02-14 22:45:40" itemprop="dateModified" datetime="2025-02-14T22:45:40+08:00">2025-02-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/" itemprop="url" rel="index"><span itemprop="name">教程100</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/" itemprop="url" rel="index"><span itemprop="name">写作</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/" itemprop="url" rel="index"><span itemprop="name">Solon</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%99%E7%A8%8B100/%E5%86%99%E4%BD%9C/Solon/Solon-%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Solon 实用教程</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>在基础篇当中，我们讲究了 Solon 对 MVC 的支持和提供的基础的Web 能力。在这个章节我们会讲解 Solon 提供了哪些能力可以供我们进行控制。</p>
<p>首先我们来看看 Solon Web  的请求过程，理解 Solon 的基础概念，这样方便我们后续的定制。</p>
<h2 id="请求过程"><a href="#请求过程" class="headerlink" title="请求过程"></a>请求过程</h2><p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjcyZDQ3ZDA2NWI4YTMxN2ZiOWQ0YzRlMWI0Y2M3MDFfOTZtdkFYRDJlaGNQZElYN0hWNWVUU3ZFTVVFTnA3Q1VfVG9rZW46SjJQQ2JzQzNZb2MxYlR4Rm1KcmNmSlY4blplXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<p>从图中，我们可以看到在Web 的请求过程中，会经过几个环节：Filter（全局过滤器）-&gt;</p>
<p>RouterInterCeptor（路由拦截器）-&gt; Handler（处理器）-&gt; Interceptor（拦截器）。</p>
<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Solon 采用 Handler + Context 架构，Context 是请求的上下文。 在 Context 中可以获取请求和响应相关的数据，包括请求相关的对象与接口，会话相关的对象与接口，响应相关的对象与接口等。Solon 提供了多种方式获取Context，也为Context 其他了一些常用的接口，更详细的内容可以查看 <a target="_blank" rel="noopener" href="https://solon.noear.org/article/216">https://solon.noear.org/article/216</a> 。</p>
<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>过滤器，可以对所有请求（无论动态还是静态的请求）进行全局的控制。通常用于全局的 Web 请求异常处理，全局的性能记录，全局的响应状态调整，全局的上下文日志记录，全局的链路跟踪等等，当然也可以作用在局部上。</p>
<h3 id="RouterInterceptor"><a href="#RouterInterceptor" class="headerlink" title="RouterInterceptor"></a>RouterInterceptor</h3><p>路由拦截器，可以对动态请求进行全局的控制，功能基本与 Filter 一致。主要的区别是：1. 只能对动态请求（路由器范围）进行拦截；2. 可以修改参数和返回结果。</p>
<h3 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h3><p>拦截器，拦截器使用切面（AOP）的方式实现，通过定义注解、设置切点、注册拦截器，Solon 将对方法进行拦截，从而增加拦截器方法的执行。拦截器可以用于实现缓存、事务等等功能。</p>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p>实际的请求方法，注册到路由器的方法（通常是<code>@Mapping</code> 函数，可以通过 Controller 的方式定义，也可以通过 Handler 的方式定义，等等）。Action 本质上是 Handler 和 Class Method 的结合，可以请求方法进行局部的控制。</p>
<h2 id="示例-demo-web02"><a href="#示例-demo-web02" class="headerlink" title="示例 demo-web02"></a>示例 demo-web02</h2><p>在 IDEA 中通过 <code>File-&gt;New-&gt;Modules...</code> 可以创建新的模块 <code>demo-web02</code>，基础代码和配置可以从<code>demo-web01</code>中拷贝过来。</p>
<p>这里我们继续补充<code>demo-web01</code> ，增加定制化的处理。</p>
<ul>
<li>增加简单的鉴权用于演示的Filter。</li>
<li>增加RouterInterceptor，用于演示Filter和RouterInterceptor的区别。 </li>
<li>增加日志审计的功能用于演示 Interceptor 拦截器。</li>
</ul>
<h3 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h3><p>使用全局的Filter做简单的 token 验证。这里需要指定<code>Component</code>的注解，也就是统一有Solon 来管理。如果有多个过滤器是可以指定<code>Component</code>的 index 参数，参数越小，越外层，可以理解为优先级越高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jfinal.kit.Kv;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.dromara.hutool.core.text.StrUtil;</span><br><span class="line"><span class="keyword">import</span> org.noear.snack.ONode;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Filter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.FilterChain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Context ctx, FilterChain chain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String path = ctx.path();</span><br><span class="line">    log.info(<span class="string">&quot;1. GlobalFilter, path: &#123;&#125;&quot;</span>, path);</span><br><span class="line">    <span class="comment">// 简单逻辑，非静态的路径都需要token</span></span><br><span class="line">    <span class="keyword">if</span> (!path.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">      String token = ctx.param(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">        ctx.outputAsJson(ONode.stringify(Kv.of(<span class="string">&quot;state&quot;</span>, <span class="keyword">false</span>)));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chain.doFilter(ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由拦截器"><a href="#路由拦截器" class="headerlink" title="路由拦截器"></a>路由拦截器</h3><p>这边只是为了对比和Filter的不同，如果是静态资源请求时，不会进入路由拦截器，也就不会打印对应的日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Component;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Handler;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.route.RouterInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.route.RouterInterceptorChain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoRouteInterceptor</span> <span class="keyword">implements</span> <span class="title">RouterInterceptor</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doIntercept</span><span class="params">(Context ctx, Handler mainHandler, RouterInterceptorChain chain)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String path = ctx.path();</span><br><span class="line">    log.info(<span class="string">&quot;2. DemoRouteInterceptor, path: &#123;&#125;&quot;</span>, path);</span><br><span class="line"></span><br><span class="line">    chain.doIntercept(ctx, mainHandler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="局部过滤器"><a href="#局部过滤器" class="headerlink" title="局部过滤器"></a>局部过滤器</h3><p>局部过滤器可以通过 Addition 注解直接使用，可以通过注解继承的方式使用。</p>
<h4 id="WhitelistFilter"><a href="#WhitelistFilter" class="headerlink" title="WhitelistFilter"></a>WhitelistFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Filter;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.FilterChain;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WhitelistFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Context ctx, FilterChain chain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String path = ctx.path();</span><br><span class="line">    log.info(<span class="string">&quot;3. WhitelistFilter, path: &#123;&#125;&quot;</span>, path);</span><br><span class="line">    chain.doFilter(ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Whitelist"><a href="#Whitelist" class="headerlink" title="Whitelist"></a>Whitelist</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.filter.WhitelistFilter;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Addition;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Addition(WhitelistFilter.class)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Whitelist &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>拦截器可以通过 Around 注解直接使用，可以通过注解继承的方式使用。</p>
<h4 id="LogInterceptor"><a href="#LogInterceptor" class="headerlink" title="LogInterceptor"></a>LogInterceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.aspect.Interceptor;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.aspect.Invocation;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">doIntercept</span><span class="params">(Invocation inv)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    Context context = Context.current();</span><br><span class="line">    String path = context.path();</span><br><span class="line">    log.info(<span class="string">&quot;4. LogInterceptor, path: &#123;&#125;&quot;</span>, path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inv.invoke();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="OperateLog"><a href="#OperateLog" class="headerlink" title="OperateLog"></a>OperateLog</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.common.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.interceptor.LogInterceptor;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.Around;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> airhead</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Around(LogInterceptor.class)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> OperateLog &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Controller的调整"><a href="#Controller的调整" class="headerlink" title="Controller的调整"></a>Controller的调整</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.web.manage.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.annotation.OperateLog;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.annotation.Whitelist;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.filter.WhitelistFilter;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.common.interceptor.LogInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.manage.dto.DeptDto;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.web.manage.service.DeptService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.Context;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.ModelAndView;</span><br><span class="line"><span class="keyword">import</span> org.noear.solon.core.handle.UploadedFile;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Mapping(&quot;/dept&quot;)</span></span><br><span class="line"><span class="meta">@Api(&quot;部门管理&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeptController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Inject</span> <span class="keyword">private</span> DeptService service;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(&quot;/index&quot;)</span></span><br><span class="line">  <span class="meta">@Get</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;浏览部门&quot;)</span></span><br><span class="line">  <span class="meta">@OperateLog</span></span><br><span class="line">  <span class="meta">@Whitelist</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    mv.put(<span class="string">&quot;depts&quot;</span>, service.list());</span><br><span class="line">    mv.view(<span class="string">&quot;dept.shtm&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mv;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Mapping(value = &quot;list&quot;)</span></span><br><span class="line">  <span class="meta">@Get</span></span><br><span class="line">  <span class="meta">@ApiOperation(&quot;获取列表&quot;)</span></span><br><span class="line">  <span class="meta">@Around(LogInterceptor.class)</span></span><br><span class="line">  <span class="meta">@Addition(WhitelistFilter.class)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;DeptDto&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> service.list();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><ul>
<li>请求 /dept/index，不带token得情况，演示全局的过滤器效果</li>
</ul>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=NmM0YjNjMGEyMzlkOTc4Njc4YjlmYWY2ZDhhZjcxYjlfYjNVcG5aelVBWVF4SDNxRXF0dFJVNUxZdUVScDNBdWpfVG9rZW46Tkw3NGJqNHhTb3p3SWt4WXFlOWNCVmJPbkpnXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<ul>
<li>请求 /dept/list?tokent=1，带token得情况，验证请求过程，使用的是 Addition 和 Around 的方式添加局部过滤器和拦截器。</li>
</ul>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=YmZmMDk1NjlhMTI0MWZlODg5MDY4ZTk1ZjU2ZDhjMTNfOEZ4cndDd1QxVjBqWlNkazBYVlhuQm91cHdoSDltYlJfVG9rZW46WVRtcmJuMVdrbzBnSTd4NjFSYWNaTDRTbkJmXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=N2I2N2I0N2FmN2JiN2Q0ZTU3NmEwMDE2YmZlOWQ3N2Rfdk1Dd2FpNU9tUU5ZQWdmWmE2eEZYcUZRT0RjeE5jekpfVG9rZW46Ulp1SmI3b29Ub0pqUXJ4T21hNWN6SE1IbkhlXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<ul>
<li>请求 /dept/index?tokent=1，带token得情况，验证请求过程，使用注解继承的方式添加局部过滤器和拦截器。</li>
</ul>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=NTNjOWY5M2RlNTYyMWQxNmIxMDhkYmE2ZTlhMWEyYmFfRTZPUFphZWZ1ZnMxT1JiZ056dDQ2VG1Wc3oyVnlLUHFfVG9rZW46U1VqSmIxSlNsbzNtaTJ4YVZ3NGNGeHhNbkNiXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=MWE1YTRlNjY5OWRhZmFhZmRkNzNhOGYxNGU1ZjQwMjBfeGlIYjFZMG1YTVhpRU5IYkpLV0RkQ2s4czNlaHZGTXdfVG9rZW46WmZRY2JPTDJpb09RSGV4UkY3N2M1aWZybmRmXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<ul>
<li>请求 /img/wechat.png，验证静态请求不会通过RouterInterceptor。如果静态资源不存在的情况，依然会继续查找动态路由，此时会进入RouterInterceptor。</li>
</ul>
<p><img src="https://otwu9ovpkn.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDI4NjE3MWQxOTllOWFiYTk4NDNjZDQ0NWZlMGExZjdfT2xUb242Z1VHNkhWaGsxVjAyZjVlNnJEdlEyM213NHdfVG9rZW46UnpTQWJKTG5Vb0tHVlh4ZlRsbGNXN3VYbkpjXzE3Mzk0NDc1MTA6MTczOTQ1MTExMF9WNA" alt="img"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本章节通过示意图的方式简单描述Solon web的请求过程，并对其中的重要概念做了讲解，通过实例的方式正式了对过滤器，路由拦截器和拦截器的定制。</p>
<p>官网对这些内容做了多篇文章的介绍，可以通过官网进一步的了解这些概念和使用方法。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">L4qiang</p>
  <div class="site-description" itemprop="description">记录点滴，注重积累。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">278</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">116</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">115</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/crazy-airhead" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;crazy-airhead" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:L4qiang@gmail.com" title="E-Mail → mailto:L4qiang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/enderjo" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;enderjo" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://ri.cms.firesbox.com/" title="https:&#x2F;&#x2F;ri.cms.firesbox.com" rel="noopener" target="_blank">践行群官方情报站</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">L4qiang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">650k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:51</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  


    </div>
</body>
</html>
